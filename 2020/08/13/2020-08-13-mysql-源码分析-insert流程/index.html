<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="è¿™æ˜¯â€œmysqlâ€ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œä¸»è¦ä»‹ç»çš„æ˜¯Insertæµç¨‹éƒ¨åˆ†æºç ã€‚  ä¸€ã€mysqlMySQL æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆRDBMSâ€“Relational Database Management Systemï¼‰">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€Šmysqlã€‹æºç åˆ†æ-Insertæµç¨‹">
<meta property="og:url" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="CHW&#39;s Notes">
<meta property="og:description" content="è¿™æ˜¯â€œmysqlâ€ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œä¸»è¦ä»‹ç»çš„æ˜¯Insertæµç¨‹éƒ¨åˆ†æºç ã€‚  ä¸€ã€mysqlMySQL æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆRDBMSâ€“Relational Database Management Systemï¼‰">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/innodb_insert%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/mtr_commit.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/Binlog%E6%8B%85%E4%BB%BB%E5%8D%8F%E8%B0%83%E8%80%85%E7%9A%84XA%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%9B%B4%E6%96%B0%E6%80%BB%E7%BB%93.png">
<meta property="article:published_time" content="2020-08-13T14:01:31.000Z">
<meta property="article:modified_time" content="2025-03-04T07:37:55.653Z">
<meta property="article:author" content="chw">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png">

<link rel="canonical" href="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ã€Šmysqlã€‹æºç åˆ†æ-Insertæµç¨‹ | CHW's Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CHW's Notes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="chw">
      <meta itemprop="description" content="do somthing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CHW's Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ã€Šmysqlã€‹æºç åˆ†æ-Insertæµç¨‹
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-08-13 22:01:31" itemprop="dateCreated datePublished" datetime="2020-08-13T22:01:31+08:00">2020-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-03-04 15:37:55" itemprop="dateModified" datetime="2025-03-04T15:37:55+08:00">2025-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">æ•°æ®åº“</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">æºç </span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E6%BA%90%E7%A0%81/Insert%E6%B5%81%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Insertæµç¨‹</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>47k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>1:56</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <pre><code>è¿™æ˜¯â€œmysqlâ€ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œä¸»è¦ä»‹ç»çš„æ˜¯Insertæµç¨‹éƒ¨åˆ†æºç ã€‚
</code></pre>
<h1 id="ä¸€ã€mysql"><a href="#ä¸€ã€mysql" class="headerlink" title="ä¸€ã€mysql"></a>ä¸€ã€mysql</h1><p><code>MySQL</code> æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆRDBMSâ€“Relational Database Management Systemï¼‰</p>
<span id="more"></span>
<p>åŸºæœ¬ç»“æ„ï¼š<br><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt="åŸºæœ¬ç»“æ„"></p>
<h1 id="äºŒã€æºç æ¶æ„å›¾"><a href="#äºŒã€æºç æ¶æ„å›¾" class="headerlink" title="äºŒã€æºç æ¶æ„å›¾"></a>äºŒã€æºç æ¶æ„å›¾</h1><p>é¦–å…ˆçœ‹ä¸€ä¸‹MySQLçš„æºç æ¶æ„å›¾ï¼Œä¸»è¦å¯ä»¥åˆ†æˆä¸‰å±‚ã€‚<br><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84.png" alt="æºç æ¶æ„"></p>
<h2 id="2-1ã€æºç ç»“æ„"><a href="#2-1ã€æºç ç»“æ„" class="headerlink" title="2.1ã€æºç ç»“æ„"></a>2.1ã€æºç ç»“æ„</h2><p>ä¸‹é¢æ˜¯8.0.41ç‰ˆæœ¬çš„æºç ç»“æ„å›¾ï¼š<br><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="æºç ç»“æ„å›¾"><br>MySqlå…¶å®å°±ä¸¤å¤§å—ï¼Œä¸€å—æ˜¯MySql Serverå±‚ï¼Œä¸€å—å°±æ˜¯Storage Engineså±‚ã€‚</p>
<ul>
<li><strong>&lt;1&gt; Client</strong><br>ä¸åŒè¯­è¨€çš„sdkéµå®ˆmysqlåè®®å°±å¯ä»¥ä¸mysqldè¿›è¡Œäº’é€šã€‚</li>
<li><strong>&lt;2&gt; Connection&#x2F;Thread Pool</strong><br>MySqlä½¿ç”¨C++ç¼–å†™ï¼ŒConnectionæ˜¯éå¸¸å®è´µçš„ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ç»´æŠ¤ä¸€ä¸ªæ± ã€‚</li>
<li><strong>&lt;3&gt; SqlInterface,Parse,Optimizer,Cache</strong><br>å¯¹sqlå¤„ç†ï¼Œè§£æï¼Œä¼˜åŒ–ï¼Œç¼“å­˜ç­‰å¤„ç†å’Œè¿‡æ»¤æ¨¡å—ï¼Œäº†è§£äº†è§£å³å¯ã€‚</li>
<li><strong>&lt;4&gt; Storage Engines</strong><br>è´Ÿè´£å­˜å‚¨çš„æ¨¡å—ï¼Œå®˜æ–¹ï¼Œç¬¬ä¸‰æ–¹ï¼Œç”šè‡³æ˜¯ä½ è‡ªå·±éƒ½å¯ä»¥è‡ªå®šä¹‰å®ç°è¿™ä¸ªæ•°æ®å­˜å‚¨ï¼Œè¿™å°±æŠŠç”Ÿæ€åšèµ·æ¥äº†ï¼ŒğŸ®ğŸ‘ƒã€‚</li>
</ul>
<h1 id="ä¸‰ã€ä¸€æ¡Insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#ä¸‰ã€ä¸€æ¡Insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="ä¸‰ã€ä¸€æ¡Insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"></a>ä¸‰ã€ä¸€æ¡Insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</h1><p>æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œä¼šè°ƒç”¨ <code>do_command()</code>. å¤„ç†ç”¨æˆ·å‘½ä»¤ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç»§ç»­åˆ†å‘</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">do_command</span><span class="params">(THD *thd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    return_value= <span class="built_in">dispatch_command</span>(command, thd, packet<span class="number">+1</span>, (uint) (packet_length<span class="number">-1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">dispatch_command</span><span class="params">(<span class="keyword">enum</span> enum_server_command command, THD *thd, <span class="type">char</span>* packet, uint packet_length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (command) &#123;</span><br><span class="line">         <span class="keyword">case</span> COM_INIT_DB: ....  <span class="keyword">break</span>;</span><br><span class="line">         ...</span><br><span class="line">         <span class="keyword">case</span> COM_QUERY:   <span class="comment">//æŸ¥è¯¢è¯­å¥ï¼š  insert xxxx</span></span><br><span class="line">             <span class="built_in">mysql_parse</span>(thd, thd-&gt;<span class="built_in">query</span>(), thd-&gt;<span class="built_in">query_length</span>(), &amp;parser_state);  <span class="comment">//sqlè§£æ</span></span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sqlè§£ææ¨¡å—</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mysql_parse</span><span class="params">(THD *thd, <span class="type">char</span> *rawbuf, uint length, Parser_state *parser_state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      error= <span class="built_in">mysql_execute_command</span>(thd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç•¥è¿‡å»ºç«‹è¿æ¥ï¼ˆæ›´å…·ä½“çš„è¿æ¥æµç¨‹ï¼ŒæŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ï¼‰ï¼Œä» <code>mysql_parse()</code> å¼€å§‹åˆ†æ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mysql_parse</span><span class="params">(THD *thd, <span class="type">char</span> *rawbuf, uint length,</span></span></span><br><span class="line"><span class="params"><span class="function">                 Parser_state *parser_state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* ...... */</span></span><br><span class="line">	</span><br><span class="line">  <span class="comment">/* æ£€æŸ¥query_cacheï¼Œå¦‚æœç»“æœå­˜åœ¨äºcacheä¸­ï¼Œç›´æ¥è¿”å› */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">query_cache_send_result_to_client</span>(thd, rawbuf, length) &lt;= <span class="number">0</span>)   </span><br><span class="line">  &#123;</span><br><span class="line">     LEX *lex= thd-&gt;lex;</span><br><span class="line"> 	 </span><br><span class="line"> 	 <span class="comment">/* è§£æè¯­å¥ */</span></span><br><span class="line">     <span class="type">bool</span> err= <span class="built_in">parse_sql</span>(thd, parser_state, <span class="literal">NULL</span>);</span><br><span class="line">		</span><br><span class="line">	 <span class="comment">/* æ•´ç†è¯­å¥æ ¼å¼ï¼Œè®°å½• general log */</span></span><br><span class="line">	 <span class="comment">/* ...... */</span></span><br><span class="line">	 		  <span class="comment">/* æ‰§è¡Œè¯­å¥ */</span></span><br><span class="line">             error= <span class="built_in">mysql_execute_command</span>(thd);</span><br><span class="line">             <span class="comment">/* æäº¤æˆ–å›æ»šæ²¡ç»“æŸçš„äº‹åŠ¡ï¼ˆäº‹åŠ¡å¯èƒ½åœ¨mysql_execute_commandä¸­æäº¤ï¼Œç”¨trx_end_by_hintæ ‡è®°äº‹åŠ¡æ˜¯å¦å·²ç»æäº¤ï¼‰ */</span></span><br><span class="line">             <span class="keyword">if</span> (!thd-&gt;trx_end_by_hint)         </span><br><span class="line">             &#123;</span><br><span class="line">               <span class="keyword">if</span> (!error &amp;&amp; lex-&gt;ci_on_success)</span><br><span class="line">                 <span class="built_in">trans_commit</span>(thd);</span><br><span class="line"> </span><br><span class="line">               <span class="keyword">if</span> (error &amp;&amp; lex-&gt;rb_on_fail)</span><br><span class="line">                 <span class="built_in">trans_rollback</span>(thd);</span><br><span class="line">             &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-1ã€-è§£æSQL"><a href="#5-1ã€-è§£æSQL" class="headerlink" title="5.1ã€ è§£æSQL"></a>5.1ã€ è§£æSQL</h2><p><code>parse_sql</code>ï¼Œä½¿ç”¨æä¾›çš„è§£æå™¨çŠ¶æ€å’Œå¯¹è±¡åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œå°†ä¸€ä¸ª SQL è¯­å¥è½¬æ¢æˆä¸€ä¸ªå‡†å¤‡è§£å†³çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---parse_sqlï¼ˆsql/sql_parse.ccï¼‰ï¼šä½¿ç”¨æä¾›çš„è§£æå™¨çŠ¶æ€å’Œå¯¹è±¡åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œå°†ä¸€ä¸ª SQL è¯­å¥è½¬æ¢æˆä¸€ä¸ªå‡†å¤‡è§£å†³çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚</span><br><span class="line">------THD::sql_parserï¼ˆsql/sql_class.ccï¼‰ï¼šé¦–å…ˆè°ƒç”¨è§£æå™¨å°†è¯­å¥è½¬æ¢ä¸ºè§£ææ ‘ï¼›ç„¶åï¼Œè¿›ä¸€æ­¥å°†è§£ææ ‘è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œä»¥å¤‡è§£æï¼ˆresolveï¼‰ä¹‹ç”¨ã€‚</span><br><span class="line">---------my_sql_parser_parseï¼šBison è§£æå™¨ç”Ÿæˆçš„è¯­æ³•è§£æå…¥å£å‡½æ•°</span><br><span class="line">---------LEX::make_sql_cmdï¼ˆsql/sql_lex.ccï¼‰ï¼šä½¿ç”¨è§£ææ ‘ï¼ˆparse_treeï¼‰å®ä¾‹åŒ–ä¸€ä¸ª Sql_cmd å¯¹è±¡ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ Lexã€‚</span><br><span class="line">------------Parse_tree_root::make_cmdï¼ˆsql/parse_tree_nodes.hï¼‰ï¼šå„ä¸ªè¯­å¥æ ¹æ®è‡ªèº«æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰æ„é€  Sql_cmt å¯¹è±¡ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="5-2ã€æ‰§è¡ŒInsertè¯­å¥"><a href="#5-2ã€æ‰§è¡ŒInsertè¯­å¥" class="headerlink" title="5.2ã€æ‰§è¡ŒInsertè¯­å¥"></a>5.2ã€æ‰§è¡ŒInsertè¯­å¥</h2><p>è¿›å…¥ <code>mysql_execute_command()</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  */</span></span><br><span class="line">  <span class="comment">/* ...... */</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">case</span> SQLCOM_INSERT:</span><br><span class="line">  &#123;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥æƒé™ */</span></span><br><span class="line">    <span class="keyword">if</span> ((res= <span class="built_in">insert_precheck</span>(thd, all_tables)))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰§è¡Œinsert */</span></span><br><span class="line">    res= <span class="built_in">mysql_insert</span>(thd, all_tables, lex-&gt;field_list, lex-&gt;many_values,</span><br><span class="line">                      lex-&gt;update_list, lex-&gt;value_list,</span><br><span class="line">                      lex-&gt;duplicates, lex-&gt;ignore);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* æäº¤æˆ–è€…å›æ»šäº‹åŠ¡ */</span></span><br><span class="line">    <span class="keyword">if</span> (!res)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">trans_commit_stmt</span>(thd);</span><br><span class="line">      <span class="built_in">trans_commit</span>(thd);</span><br><span class="line">      thd-&gt;trx_end_by_hint= TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (res)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">trans_rollback_stmt</span>(thd);</span><br><span class="line">      <span class="built_in">trans_rollback</span>(thd);</span><br><span class="line">      thd-&gt;trx_end_by_hint= TRUE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥ mysql_insert()ï¼Œæºç åœ¨<code>sql/sql_insert.cc</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">mysql_insert</span><span class="params">(THD *thd,TABLE_LIST *table_list,</span></span></span><br><span class="line"><span class="params"><span class="function">                  List&lt;Item&gt; &amp;fields, <span class="comment">/* insert çš„å­—æ®µ */</span></span></span></span><br><span class="line"><span class="params"><span class="function">                  List&lt;List_item&gt; &amp;values_list, <span class="comment">/* insert çš„å€¼ */</span></span></span></span><br><span class="line"><span class="params"><span class="function">                  List&lt;Item&gt; &amp;update_fields,</span></span></span><br><span class="line"><span class="params"><span class="function">                  List&lt;Item&gt; &amp;update_values,</span></span></span><br><span class="line"><span class="params"><span class="function">                  enum_duplicates duplic,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">bool</span> ignore)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="comment">/*å¯¹æ¯æ¡è®°å½•è°ƒç”¨ write_record */</span></span><br><span class="line">  <span class="keyword">while</span> ((values= its++))</span><br><span class="line">  &#123;</span><br><span class="line">	<span class="keyword">if</span> (lock_type == TL_WRITE_DELAYED)</span><br><span class="line">    &#123;</span><br><span class="line">      LEX_STRING <span class="type">const</span> st_query = &#123; query, thd-&gt;<span class="built_in">query_length</span>() &#125;;</span><br><span class="line">      <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;before_write_delayed&quot;</span>);</span><br><span class="line">      <span class="comment">/* insert delay */</span></span><br><span class="line">      error= <span class="built_in">write_delayed</span>(thd, table, st_query, log_on, &amp;info);</span><br><span class="line">      <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;after_write_delayed&quot;</span>);</span><br><span class="line">      query=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="comment">/* normal insert */</span></span><br><span class="line">      error= <span class="built_in">write_record</span>(thd, table, &amp;info, &amp;update);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è¿™é‡Œè¿˜æœ‰</span></span><br><span class="line"><span class="comment">    thd-&gt;binlog_query()å†™binlog</span></span><br><span class="line"><span class="comment">    my_ok()è¿”å›okæŠ¥æ–‡ï¼ŒokæŠ¥æ–‡ä¸­åŒ…å«å½±å“è¡Œæ•°</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<p>è¿›å…¥ write_record</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  COPY_INFO *info ç”¨æ¥å¤„ç†å”¯ä¸€é”®å†²çªï¼Œè®°å½•å½±å“è¡Œæ•°</span></span><br><span class="line"><span class="comment">  COPY_INFO *update å¤„ç† INSERT ON DUPLICATE KEY UPDATE ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">write_record</span><span class="params">(THD *thd, TABLE *table, COPY_INFO *info, COPY_INFO *update)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (duplicate_handling == DUP_REPLACE || duplicate_handling == DUP_UPDATE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* å¤„ç† INSERT ON DUPLICATE KEY UPDATE ç­‰å¤æ‚æƒ…å†µ */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((error=table-&gt;file-&gt;<span class="built_in">ha_write_row</span>(table-&gt;record[<span class="number">0</span>])))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;write_row_noreplace&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ignore_errors ||</span><br><span class="line">        table-&gt;file-&gt;<span class="built_in">is_fatal_error</span>(error, HA_CHECK_DUP))</span><br><span class="line">      <span class="keyword">goto</span> err; </span><br><span class="line">    table-&gt;file-&gt;<span class="built_in">restore_auto_increment</span>(prev_insert_id);</span><br><span class="line">    <span class="keyword">goto</span> ok_or_after_trg_err;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ ha_write_row. æºç åœ¨<code>sql/handler.cc</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* handler æ˜¯å„ä¸ªå­˜å‚¨å¼•æ“çš„åŸºç±»ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨InnoDBå¼•æ“*/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">handler::ha_write_row</span><span class="params">(uchar *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* æŒ‡å®šlog_eventç±»å‹*/</span></span><br><span class="line">  Log_func *log_func= Write_rows_log_event::binlog_row_logging_function;</span><br><span class="line">  error= <span class="built_in">write_row</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handler æ˜¯å„ä¸ªå­˜å‚¨å¼•æ“çš„åŸºç±»ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨InnoDBå¼•æ“ã€‚å†å¾€ä¸‹æ˜¯è¿›å…¥å¼•æ“çš„write_rowã€‚<font color="green"><strong>write_rowæ˜¯ä¸ªè™šæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç»™åº•å±‚æ–¹æ³•å®ç°çš„ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ç»™å„å¤§Storage Enginesçš„å“ˆ</strong></font>ï¼Œè¿›å…¥å¼•æ“å±‚ï¼Œè¿™é‡Œæ˜¯innodbå¼•æ“ï¼Œhandlerå¯¹åº”ha_innobase æ’å…¥çš„è¡¨ä¿¡æ¯ä¿å­˜åœ¨handlerä¸­</p>
<h3 id="5-2-1ã€innodbæ‰§è¡Œæ’å…¥"><a href="#5-2-1ã€innodbæ‰§è¡Œæ’å…¥" class="headerlink" title="5.2.1ã€innodbæ‰§è¡Œæ’å…¥"></a>5.2.1ã€innodbæ‰§è¡Œæ’å…¥</h3><p>å…ˆçœ‹ä¸€ä¸‹æ•´ä½“çš„æµç¨‹ï¼š<br><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/innodb_insert%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="åŸºæœ¬ç»“æ„"><br>å†åˆ†æå…·ä½“çš„æºç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">ha_innobase::write_row</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*===================*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        uchar*  record)</span> <span class="comment">/*!&lt; in: a row in MySQL format */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		error = <span class="built_in">row_insert_for_mysql</span>((byte*) record, prebuilt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">UNIV_INTERN</span></span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_insert_for_mysql</span><span class="params">(                                                                                                                                                                                       </span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*=================*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        byte*           mysql_rec,      <span class="comment">/*!&lt; in: row in the MySQL format */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">row_prebuilt_t</span>* prebuilt)</span>       <span class="comment">/*!&lt; in: prebuilt struct in MySQL</span></span></span><br><span class="line"><span class="comment"><span class="function">                                        handle */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="comment">/*è®°å½•æ ¼å¼ä»MySQLè½¬æ¢æˆInnoDB*/</span></span><br><span class="line">		<span class="built_in">row_mysql_convert_row_to_innobase</span>(node-&gt;row, prebuilt, mysql_rec);</span><br><span class="line">	</span><br><span class="line">        thr-&gt;run_node = node;</span><br><span class="line">        thr-&gt;prev_node = node;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*æ’å…¥è®°å½•*/</span></span><br><span class="line">        <span class="built_in">row_ins_step</span>(thr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNIV_INTERN</span></span><br><span class="line"><span class="function"><span class="type">que_thr_t</span>*</span></span><br><span class="line"><span class="function"><span class="title">row_ins_step</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*=========*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">que_thr_t</span>*      thr)</span>    <span class="comment">/*!&lt; in: query thread */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="comment">/*ç»™è¡¨åŠ IXé”*/</span></span><br><span class="line">		err = <span class="built_in">lock_table</span>(<span class="number">0</span>, node-&gt;table, LOCK_IX, thr);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*æ’å…¥è®°å½•*/</span></span><br><span class="line">		err = <span class="built_in">row_ins</span>(node, thr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InnoDBè¡¨æ˜¯åŸºäºB+æ ‘çš„ç´¢å¼•ç»„ç»‡è¡¨</p>
<p>å¦‚æœInnoDBè¡¨æ²¡æœ‰ä¸»é”®å’Œå”¯ä¸€é”®ï¼Œéœ€è¦åˆ†é…éšå«çš„row_idç»„ç»‡èšé›†ç´¢å¼•</p>
<p>row_idåˆ†é…é€»è¾‘åœ¨row_insä¸­ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __attribute__((nonnull, warn_unused_result))</span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_ins</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*====*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">ins_node_t</span>*     node,   <span class="comment">/*!&lt; in: row insert node */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">que_thr_t</span>*      thr)</span>    <span class="comment">/*!&lt; in: query thread */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (node-&gt;state == INS_NODE_ALLOC_ROW_ID) &#123;</span><br><span class="line">				<span class="comment">/*è‹¥innodbè¡¨æ²¡æœ‰ä¸»é”®å’Œå”¯ä¸€é”®ï¼Œç”¨row_idç»„ç»‡ç´¢å¼•*/</span></span><br><span class="line">        		<span class="built_in">row_ins_alloc_row_id_step</span>(node);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">/*è·å–row_idçš„ç´¢å¼•*/</span></span><br><span class="line">                node-&gt;index = <span class="built_in">dict_table_get_first_index</span>(node-&gt;table);</span><br><span class="line">                node-&gt;entry = <span class="built_in">UT_LIST_GET_FIRST</span>(node-&gt;entry_list);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*éå†æ‰€æœ‰ç´¢å¼•ï¼Œå‘æ¯ä¸ªç´¢å¼•ä¸­æ’å…¥è®°å½•*/</span></span><br><span class="line">		<span class="keyword">while</span> (node-&gt;index != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node-&gt;index-&gt;type != DICT_FTS) &#123;</span><br><span class="line">                        <span class="comment">/* å‘ç´¢å¼•ä¸­æ’å…¥è®°å½• */</span></span><br><span class="line">                        err = <span class="built_in">row_ins_index_entry_step</span>(node, thr);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">return</span>(err);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;                                                                                                                                                                                           </span><br><span class="line">				</span><br><span class="line">				<span class="comment">/*è·å–ä¸‹ä¸€ä¸ªç´¢å¼•*/</span></span><br><span class="line">                node-&gt;index = <span class="built_in">dict_table_get_next_index</span>(node-&gt;index);</span><br><span class="line">                node-&gt;entry = <span class="built_in">UT_LIST_GET_NEXT</span>(tuple_list, node-&gt;entry);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ’å…¥å•ä¸ªç´¢å¼•é¡¹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __attribute__((nonnull, warn_unused_result))</span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_ins_index_entry_step</span><span class="params">(                                                                                                                                                                                   </span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*=====================*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">ins_node_t</span>*     node,   <span class="comment">/*!&lt; in: row insert node */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">que_thr_t</span>*      thr)</span>    <span class="comment">/*!&lt; in: query thread */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">dberr_t</span> err;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*ç»™ç´¢å¼•é¡¹èµ‹å€¼*/</span></span><br><span class="line">        <span class="built_in">row_ins_index_entry_set_vals</span>(node-&gt;index, node-&gt;entry, node-&gt;row);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*æ’å…¥ç´¢å¼•é¡¹*/</span></span><br><span class="line">        err = <span class="built_in">row_ins_index_entry</span>(node-&gt;index, node-&gt;entry, thr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-1-1ã€æ’å…¥ç´¢å¼•è®°å½•"><a href="#5-2-1-1ã€æ’å…¥ç´¢å¼•è®°å½•" class="headerlink" title="5.2.1.1ã€æ’å…¥ç´¢å¼•è®°å½•"></a>5.2.1.1ã€æ’å…¥ç´¢å¼•è®°å½•</h4><p>æ’å…¥æ“ä½œåˆåˆ†ä¸ºï¼šèšåˆç´¢å¼•ã€ç»„åˆç´¢å¼•ä»¥åŠäºŒçº§ç´¢å¼•ã€‚</p>
<ul>
<li>é€»è¾‘éƒ½ä¼šå…ˆå°è¯•pageä¸åˆ†ç¦»çš„æ’å…¥æ–¹å¼ï¼Œéœ€è¦å®šä½åˆ°è®°å½•æ’å…¥çš„ä½ç½®ï¼Œå®Œæˆmlogçš„æ•°æ®æ›´æ–°ï¼Œåœ¨mtræäº¤è¿‡ç¨‹ä¸­ï¼Œ<ul>
<li>1ã€redoå†™å…¥å…¬å…±bufferï¼›</li>
<li>2ã€æŠŠæ›´æ–°çš„pageåŠ åˆ°buffer poolçš„flush listï¼Œè„é¡µä¸Šè®°å½•çš„lsnä¸ºå½“å‰mtrå†™å…¥çš„ç»“æŸç‚¹lsnï¼ŒåŸºäºåŠ é”é€»è¾‘ï¼Œèƒ½å¤Ÿä¿è¯flush listä¸Šçš„è„é¡µæ€»æ˜¯ä»¥LSNæ’åºã€‚</li>
</ul>
</li>
</ul>
<p><code>row_ins_index_entry</code> å‡½æ•°çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸€æ¡æ–°çš„ç´¢å¼•è®°å½•æ’å…¥åˆ° InnoDB å­˜å‚¨å¼•æ“çš„ç´¢å¼•ç»“æ„ä¸­ï¼Œæ‰§è¡Œçš„å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">row_ins_index_entry</span><br><span class="line">  |--&gt; row_ins_clust_index_entry // èšåˆç´¢å¼•insert [å±•å¼€]</span><br><span class="line">  |--&gt; row_ins_sec_index_multi_value_entry // ç»„åˆç´¢å¼•insert</span><br><span class="line">  |--&gt; row_ins_sec_index_entry // äºŒçº§ç´¢å¼•insert</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span></span></span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_ins_index_entry</span><span class="params">(                                                                                                                                                                                        </span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*================*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">dict_index_t</span>*   index,  <span class="comment">/*!&lt; in: index */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">dtuple_t</span>*       entry,  <span class="comment">/*!&lt; in/out: index entry to insert */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">que_thr_t</span>*      thr)</span>    <span class="comment">/*!&lt; in: query thread */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">dict_index_is_clust</span>(index)) &#123;</span><br><span class="line">        		<span class="comment">/* æ’å…¥èšé›†ç´¢å¼• */</span></span><br><span class="line">                <span class="keyword">return</span>(<span class="built_in">row_ins_clust_index_entry</span>(index, entry, thr, <span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        		<span class="comment">/* æ’å…¥äºŒçº§ç´¢å¼• */</span></span><br><span class="line">                <span class="built_in">return</span>(<span class="built_in">row_ins_sec_index_entry</span>(index, entry, thr));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>row_ins_clust_index_entry å’Œ row_ins_sec_index_entry å‡½æ•°ç»“æ„ç±»ä¼¼ï¼Œåªåˆ†ææ’å…¥èšé›†ç´¢å¼•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<h5 id="1-èšåˆç´¢å¼•-Insert-Recordæµç¨‹"><a href="#1-èšåˆç´¢å¼•-Insert-Recordæµç¨‹" class="headerlink" title="1. èšåˆç´¢å¼• Insert Recordæµç¨‹"></a>1. èšåˆç´¢å¼• Insert Recordæµç¨‹</h5><p>æ–¹æ³•æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">åˆ†æ”¯1ï¼š </span><br><span class="line">  |--&gt; row_ins_clust_index_entry // èšåˆç´¢å¼•insert</span><br><span class="line">  |  |--&gt; row_ins_clust_index_entry_low(BTR_MODIFY_LEAF) // å°è¯•ä¹è§‚æ–¹å¼æ›´æ–°B+Treeå¶å­èŠ‚ç‚¹ï¼ŒåŠ x-latché”[å±•å¼€]</span><br><span class="line">  |  |--&gt; row_ins_clust_index_entry_low(BTR_MODIFY_TREE) // æ‚²è§‚æ–¹å¼æ›´æ–°æ•´ä½“B+Tree </span><br><span class="line"></span><br><span class="line">row_ins_clust_index_entry_low â‘ </span><br><span class="line">  |--&gt; mtr.start();     // åšä¸€äº›åˆå§‹åŒ–ã€‚</span><br><span class="line">  |--&gt; btr_cur_optimistic_insert // å‡è®¾å·²ç»è·å¾—è¯¥Pageçš„x-latché”ï¼Œå°è¯•åœ¨æ¸¸æ ‡çš„ä¸‹ä¸€ä¸ªä½ç½®æ’å…¥Rowã€‚</span><br><span class="line">  |  |--&gt; btr_cur_ins_lock_and_undo // å†™undolog</span><br><span class="line">  |  |  |--&gt; trx_undo_report_row_operation // åœ¨undoè®°å½•insertã€updateã€èšåˆç´¢å¼•åˆ é™¤æ ‡è®° è¿™äº›ä¿¡æ¯ã€‚å†…å« mtr_start/mtr_commit </span><br><span class="line">  |  |  |  |--&gt; trx_undo_assign_undo // åˆ›å»ºæˆ–è€…å¤ç”¨ä¸€ä¸ªundo_log, å†…å« mtr_start/mtr_commit </span><br><span class="line">  |  |--&gt; page_cur_tuple_insert // åœ¨Pageæ¸¸æ ‡çš„ä¸‹ä¸€ä¸ªä½ç½®ç‚¹Insertæ•°æ®</span><br><span class="line">  |  |  |--&gt; page_cur_insert_rec_low // [è§ä¸‹æ–‡] â‘¡</span><br><span class="line">  |  |  |--&gt; page_cur_insert_rec_zip //  if å‹ç¼©é¡µçš„æƒ…å†µ </span><br><span class="line">  |--&gt; btr_cur_pessimistic_insert // å¦‚æœä¹è§‚æƒ…å†µå¤±è´¥ï¼Œè°ƒç”¨æ‚²è§‚Insertæ¥å£</span><br><span class="line">  |--&gt; mtr.commit();  // [è§ä¸‹æ–‡] â‘¢</span><br><span class="line"></span><br><span class="line"> page_cur_insert_rec_low â‘¡</span><br><span class="line">  |--&gt; 1-8: //ä¸ºRecordåˆ†é…å†…å­˜ï¼Œå¹¶æ·»åŠ åˆ°B+Treeä¸Š</span><br><span class="line">  |--&gt; 9. page_cur_insert_rec_write_log // ä¸ºRedo Record of Insert Recordåˆ†é…å†…å­˜ï¼ˆè‡ªå®šä¹‰çš„heapï¼‰</span><br><span class="line">                                        // å¹¶è®°å½•åœ¨Pageä¸Š</span><br><span class="line">  |  |--&gt; å…ˆå¯»æ‰¾ insert_recordçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span><br><span class="line">  |  |--&gt; è®¡ç®—mlogå¤§å°; mlog_open //ä¸ºmlogåˆ†é…å†…å­˜</span><br><span class="line">  |  |--&gt; mlog_write_initial_log_record_fast //åˆå§‹åŒ–mlog,è¿™é‡Œçš„mlogç±»å‹ MLOG_COMP_REC_INSERT</span><br><span class="line">  //|  |--&gt; dict_index_get_n_unique_in_tree </span><br><span class="line">          // è®¡ç®—è¡ŒRecordä¸Šå†³å®šå”¯ä¸€æ€§çš„åˆ—(field)æ•°ï¼Œä¹Ÿå°±æ˜¯èšåˆç´¢å¼•=ä¸»é”®æ•°ï¼ŒäºŒçº§ç´¢å¼•=ä¸»é”®+äºŒçº§ç´¢å¼•æ•°</span><br><span class="line">  |  |--&gt; memcpy(log_ptr, ins_ptr, rec_size); // æŠŠinsertæŒ‡é’ˆæ‹·è´ç»™redologæŒ‡é’ˆ </span><br><span class="line">  |  |--&gt; mlog_close // å…³é—­mlog</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œ<code>row_ins_clust_index_entry</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNIV_INTERN</span></span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_ins_clust_index_entry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">/*======================*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">dict_index_t</span>*   index,  <span class="comment">/*!&lt; in: clustered index */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">dtuple_t</span>*       entry,  <span class="comment">/*!&lt; in/out: index entry to insert */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">que_thr_t</span>*      thr,    <span class="comment">/*!&lt; in: query thread */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ulint           n_ext)</span>  <span class="comment">/*!&lt; in: number of externally stored columns */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">UT_LIST_GET_FIRST</span>(index-&gt;table-&gt;foreign_list)) &#123;</span><br><span class="line">                err = <span class="built_in">row_ins_check_foreign_constraints</span>(</span><br><span class="line">                        index-&gt;table, index, entry, thr);</span><br><span class="line">                <span class="keyword">if</span> (err != DB_SUCCESS) &#123;</span><br><span class="line">                        <span class="keyword">return</span>(err);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* flush logï¼Œmake checkpointï¼ˆå¦‚æœéœ€è¦ï¼‰ */</span></span><br><span class="line">        <span class="built_in">log_free_check</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* å…ˆå°è¯•ä¹è§‚æ’å…¥ï¼Œä¿®æ”¹å¶å­èŠ‚ç‚¹ BTR_MODIFY_LEAF */</span></span><br><span class="line">        err = <span class="built_in">row_ins_clust_index_entry_low</span>(</span><br><span class="line">                <span class="number">0</span>, BTR_MODIFY_LEAF, index, n_uniq, entry, n_ext, thr, </span><br><span class="line">                &amp;page_no, &amp;modify_clock);</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> (err != DB_FAIL) &#123;</span><br><span class="line">                <span class="built_in">DEBUG_SYNC_C</span>(<span class="string">&quot;row_ins_clust_index_entry_leaf_after&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>(err);</span><br><span class="line">        &#125;    </span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* flush logï¼Œmake checkpointï¼ˆå¦‚æœéœ€è¦ï¼‰ */</span></span><br><span class="line">        <span class="built_in">log_free_check</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* ä¹è§‚æ’å…¥å¤±è´¥ï¼Œå°è¯•æ‚²è§‚æ’å…¥ BTR_MODIFY_TREE */</span></span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">row_ins_clust_index_entry_low</span>(</span><br><span class="line">                        <span class="number">0</span>, BTR_MODIFY_TREE, index, n_uniq, entry, n_ext, thr,</span><br><span class="line">                        &amp;page_no, &amp;modify_clock));</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNIV_INTERN</span></span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">row_ins_clust_index_entry_low</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/*å¯åŠ¨mini transaction*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">    mtr_start(&amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/* å°†cursorç§»åŠ¨åˆ°ç´¢å¼•ä¸Šå¾…æ’å…¥çš„ä½ç½® */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    btr_cur_search_to_nth_level(index, <span class="number">0</span>, entry, PAGE_CUR_LE, mode,                                                                                                                                     </span></span></span><br><span class="line"><span class="params"><span class="function">                                &amp;cursor, <span class="number">0</span>, __FILE__, __LINE__, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">/*æ ¹æ®ä¸åŒçš„flagæ£€æŸ¥ä¸»é”®å†²çª*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">                    err = row_ins_duplicate_error_in_clust_online(</span></span></span><br><span class="line"><span class="params"><span class="function">                            n_uniq, entry, &amp;cursor,</span></span></span><br><span class="line"><span class="params"><span class="function">                            &amp;offsets, &amp;offsets_heap);</span></span></span><br><span class="line"><span class="params"><span class="function">                    err = row_ins_duplicate_error_in_clust(</span></span></span><br><span class="line"><span class="params"><span class="function">                            flags, &amp;cursor, entry, thr, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="comment">/*</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">      å¦‚æœè¦æ’å…¥çš„ç´¢å¼•é¡¹å·²å­˜åœ¨ï¼Œåˆ™æŠŠinsertæ“ä½œæ”¹ä¸ºupdateæ“ä½œ</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">      ç´¢å¼•é¡¹å·²å­˜åœ¨ï¼Œä¸”æ²¡æœ‰ä¸»é”®å†²çªï¼Œæ˜¯å› ä¸ºä¹‹å‰çš„ç´¢å¼•é¡¹å¯¹åº”çš„æ•°æ®è¢«æ ‡è®°ä¸ºå·²åˆ é™¤</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">      æœ¬æ¬¡æ’å…¥çš„æ•°æ®å’Œä¸Šæ¬¡åˆ é™¤çš„ä¸€æ ·ï¼Œè€Œç´¢å¼•é¡¹å¹¶æœªåˆ é™¤ï¼Œæ‰€ä»¥å˜ä¸ºupdateæ“ä½œ		</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">    */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">if</span> (row_ins_must_modify_rec(&amp;cursor)) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">/* There is already an index entry with a long enough common</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">            prefix, we must convert the insert into a modify of an</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">            existing record */</span></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">mem_heap_t</span>*     entry_heap      = mem_heap_create(<span class="number">1024</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">            </span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">/* æ›´æ–°æ•°æ®åˆ°å­˜åœ¨çš„ç´¢å¼•é¡¹ */</span></span></span></span><br><span class="line"><span class="params"><span class="function">            err = row_ins_clust_index_entry_by_modify(</span></span></span><br><span class="line"><span class="params"><span class="function">                    flags, mode, &amp;cursor, &amp;offsets, &amp;offsets_heap,</span></span></span><br><span class="line"><span class="params"><span class="function">                    entry_heap, &amp;big_rec, entry, thr, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">            </span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">/*å¦‚æœç´¢å¼•æ­£åœ¨online_ddlï¼Œå…ˆè®°å½•insert*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">if</span> (err == DB_SUCCESS &amp;&amp; dict_index_is_online_ddl(index)) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    row_log_table_insert(rec, index, offsets);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">/*æäº¤mini transaction*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">            mtr_commit(&amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">            mem_heap_free(entry_heap);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">rec_t</span>*  insert_rec;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">if</span> (mode != BTR_MODIFY_TREE) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">/*è¿›è¡Œä¸€æ¬¡ä¹è§‚æ’å…¥*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">                    err = btr_cur_optimistic_insert(</span></span></span><br><span class="line"><span class="params"><span class="function">                            flags, &amp;cursor, &amp;offsets, &amp;offsets_heap,</span></span></span><br><span class="line"><span class="params"><span class="function">                            entry, &amp;insert_rec, &amp;big_rec,</span></span></span><br><span class="line"><span class="params"><span class="function">                            n_ext, thr, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">/*</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">                      å¦‚æœbuffer poolä½™é‡ä¸è¶³25%ï¼Œæ’å…¥å¤±è´¥ï¼Œè¿”å›DB_LOCK_TABLE_FULL</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">                      å¤„ç†DB_LOCK_TABLE_FULLé”™è¯¯æ—¶ï¼Œä¼šå›æ»šäº‹åŠ¡</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">                      é˜²æ­¢å¤§äº‹åŠ¡çš„é”å æ»¡buffer pool(æ³¨é‡Šé‡Œå†™çš„)</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">                    */</span></span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (buf_LRU_buf_pool_running_out()) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                            err = DB_LOCK_TABLE_FULL;</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">goto</span> err_exit;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (<span class="comment">/*å¤ªé•¿äº†ï¼Œç•¥*/</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="comment">/*è¿›è¡Œä¸€æ¬¡ä¹è§‚æ’å…¥*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">                            err = btr_cur_optimistic_insert(</span></span></span><br><span class="line"><span class="params"><span class="function">                                    flags, &amp;cursor,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    &amp;offsets, &amp;offsets_heap,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    entry, &amp;insert_rec, &amp;big_rec,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    n_ext, thr, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                            err = DB_FAIL;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (err == DB_FAIL) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="comment">/*ä¹è§‚æ’å…¥å¤±è´¥ï¼Œè¿›è¡Œæ‚²è§‚æ’å…¥*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">                            err = btr_cur_pessimistic_insert(</span></span></span><br><span class="line"><span class="params"><span class="function">                                    flags, &amp;cursor,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    &amp;offsets, &amp;offsets_heap,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    entry, &amp;insert_rec, &amp;big_rec,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    n_ext, thr, &amp;mtr);</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>btr_cur_optimistic_insert å’Œ btr_cur_pessimistic_insert æ¶‰åŠB+æ ‘çš„æ“ä½œï¼Œå†…éƒ¨ç»†èŠ‚å¾ˆå¤šï¼Œä»¥åå†åšåˆ†æ</p>
<h5 id="2-æäº¤mini-transaction"><a href="#2-æäº¤mini-transaction" class="headerlink" title="2. æäº¤mini transaction"></a>2. æäº¤mini transaction</h5><p>åœ¨<code>row_ins_clust_index_entry_low</code>æ–¹æ³•å†…éƒ¨ï¼Œä¼šæ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mtr_start(&amp;mtr);</span><br><span class="line">/*æäº¤mini transaction*/</span><br><span class="line">mtr_commit(&amp;mtr);</span><br></pre></td></tr></table></figure>
<p>InnoDBä¼šå°†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹æ‹†åˆ†ä¸ºè‹¥å¹²ä¸ªMini Transactionï¼ˆmtrï¼‰ï¼Œæ¯ä¸ªmtråŒ…å«ä¸€ç³»åˆ—å¦‚åŠ é”ï¼Œå†™æ•°æ®ï¼Œå†™redoï¼Œæ”¾é”ç­‰æ“ä½œ</p>
<p>æ›´è¯¦ç»†çš„è¯·æŸ¥çœ‹äº‹åŠ¡æäº¤ç« èŠ‚çš„mtr_t::commit()å°èŠ‚ã€‚</p>
<h2 id="5-3ã€äº‹åŠ¡æäº¤"><a href="#5-3ã€äº‹åŠ¡æäº¤" class="headerlink" title="5.3ã€äº‹åŠ¡æäº¤"></a>5.3ã€äº‹åŠ¡æäº¤</h2><p>å›åˆ°SQLè§£æéƒ¨åˆ†ï¼Œä»æºç ä¸Šäº†è§£åˆ°ï¼Œåœ¨æ‰§è¡Œå®Œæˆinsertåï¼Œä¼šç»§ç»­æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œä» <code>trans_commit(THD *thd)</code> å‡½æ•°å¼€å§‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">trans_commit</span><span class="params">(THD *thd)</span></span>&#123;</span><br><span class="line">  <span class="comment">// æäº¤äº‹åŠ¡ã€‚</span></span><br><span class="line">  res = <span class="built_in">ha_commit_trans</span>(thd, TRUE);</span><br><span class="line">  <span class="keyword">if</span> (res == FALSE)</span><br><span class="line">    <span class="keyword">if</span> (thd-&gt;rpl_thd_ctx.<span class="built_in">session_gtids_ctx</span>().<span class="built_in">notify_after_transaction_commit</span>(thd))</span><br><span class="line">      <span class="built_in">sql_print_warning</span>(<span class="string">&quot;Failed to collect GTID to send in the response packet!&quot;</span>);</span><br><span class="line">  thd-&gt;server_status &amp;= ~SERVER_STATUS_IN_TRANS;</span><br><span class="line">  thd-&gt;variables.option_bits &amp;= ~OPTION_BEGIN;</span><br><span class="line">  thd-&gt;<span class="built_in">get_transaction</span>()-&gt;<span class="built_in">reset_unsafe_rollback_flags</span>(Transaction_ctx::SESSION);</span><br><span class="line">  thd-&gt;lex-&gt;start_transaction_opt = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* The transaction should be marked as complete in P_S. */</span></span><br><span class="line">  <span class="built_in">assert</span>(thd-&gt;m_transaction_psi == <span class="literal">NULL</span>);</span><br><span class="line">  thd-&gt;tx_priority = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">trans_track_end_trx</span>(thd);</span><br><span class="line">  <span class="built_in">DBUG_RETURN</span>(<span class="built_in">MY_TEST</span>(res));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-1ã€äº‹åŠ¡æäº¤æ€»æµç¨‹"><a href="#5-3-1ã€äº‹åŠ¡æäº¤æ€»æµç¨‹" class="headerlink" title="5.3.1ã€äº‹åŠ¡æäº¤æ€»æµç¨‹"></a>5.3.1ã€äº‹åŠ¡æäº¤æ€»æµç¨‹</h3><p>æ¥ä¸‹æ¥è¿›å…¥<code>ha_commit_trans</code>æ‰§è¡Œå †æ ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>è¯¥å‡½æ•°è´Ÿè´£å¤„ç† binlog å±‚å’Œå­˜å‚¨å¼•æ“å±‚çš„æäº¤ã€‚é‡Œé¢å°±æ¶‰åŠåˆ°äº†<font color="red"><strong>ä¸¤é˜¶æ®µæäº¤</strong></font></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ha_commit_trans // XA transaction å³å¯ç†è§£ä¸º 2PC ä¸¤é˜¶æ®µæäº¤åè®®ã€‚</span><br><span class="line">                // äº‹åŠ¡åè°ƒå™¨ï¼ˆTransaction Coordinatorï¼‰æ¥å¤„ç†å„èŠ‚ç‚¹æ˜¯å›é€€è¿˜æ˜¯å‰æ»š, tc_logå³åè°ƒè€…æ—¥å¿—ã€‚</span><br><span class="line">  |--&gt; tc_log-&gt;prepare()</span><br><span class="line">  |  |--&gt; MYSQL_BIN_LOG::prepare--&gt; ha_prepare_low/(ht-&gt;prepare)--&gt; innobase_xa_prepare // prepare binlog</span><br><span class="line">           // innodb å­˜å‚¨å¼•æ“åˆå§‹åŒ– innodb_init() /storage/innobase/handler/ha_innodb.cc</span><br><span class="line">           // innobase_hton-&gt;prepare = innobase_xa_prepare</span><br><span class="line">  |  |--&gt; innobase_xa_prepare --&gt;trx_prepare// prepare an X/Open XA åˆ†å¸ƒå¼äº‹åŠ¡</span><br><span class="line">  |  |  |--&gt; trx_prepare_low</span><br><span class="line">  |  |  |  |--&gt; mtr_start_sync()</span><br><span class="line">  |  |  |  |--&gt; trx_undo_set_state_at_prepare // undolog çŠ¶æ€ä»TRX_UNDO_ACTIVEè®¾ç½®ä¸ºTRX_UNDO_PREPARED</span><br><span class="line">  |  |  |  |  |--&gt; trx_undo_page_get // è·å¾— undo page</span><br><span class="line">  |  |  |  |  |--&gt; trx_undo_gtid_write // å‘undo headerå†™GTIDä¿¡æ¯</span><br><span class="line">  |  |  |  |  |--&gt; trx_undo_write_xid // å‘undo headerå†™XIDä¿¡æ¯</span><br><span class="line">  |  |  |  |--&gt; mtr_commit</span><br><span class="line"></span><br><span class="line">  |--&gt; tc_log-&gt;commit()</span><br><span class="line">  |  |--&gt; MYSQL_BIN_LOG::commit</span><br><span class="line">  |  |  |--&gt; binlog_cache_data::finalize() // å†™eventsåˆ°cache</span><br><span class="line">  |  |  |--&gt; MYSQL_BIN_LOG::ordered_commit() // å¤§æ¥å£ï¼Œbinlog commit</span><br><span class="line">// Step1: flushing transactions to binary log</span><br><span class="line">  |  |  |  |--&gt; MYSQL_BIN_LOG::process_flush_stage_queue() // flush cache</span><br><span class="line">  |  |  |  |  |--&gt; assign_automatic_gtids_to_flush_group // ç”ŸæˆGTID</span><br><span class="line">  |  |  |  |  |--&gt; flush_thread_caches // flush cache for session,Write the Gtid_log_event to the binary log</span><br><span class="line">  |  |  |  |--&gt; MYSQL_BIN_LOG::flush_cache_to_file() // Flush binary log I/O cacheåˆ°binlogæ–‡ä»¶</span><br><span class="line">// Step2: Syncing binary log file to disk</span><br><span class="line">  |  |  |  |--&gt; MYSQL_BIN_LOG::sync_binlog_file--&gt; IO_CACHE_ostream::sync()--&gt; inline_mysql_file_sync()</span><br><span class="line">		--&gt; my_sync --&gt;fdatasync // call fsync() to sync the file to disk</span><br><span class="line">// Step3: Commit all transactions in order</span><br><span class="line">  |  |  |  |--&gt; MYSQL_BIN_LOG::process_commit_stage_queue() // flush cache</span><br><span class="line">  |  |  |  |  |--&gt; ha_commit_low // storage engine commit // innobase_hton-&gt;commit = innobase_commit;</span><br><span class="line">  |  |  |  |  |--&gt; innobase_commit --&gt;innobase_commit_low--&gt;trx_commit_for_mysql //æ­¤æ—¶rtxçš„çŠ¶æ€ä¸ºTRX_STATE_PREPARED</span><br><span class="line">  |  |  |  |  |  |--&gt; trx_commit</span><br><span class="line">  |  |  |  |  |  |  |--&gt; mtr_start_sync //mtr_start</span><br><span class="line">  |  |  |  |  |  |  |--&gt; trx_commit_low // Commits a transaction and a mini-transaction.</span><br><span class="line">  |  |  |  |  |  |  |  |--&gt; trx_write_serialisation_history // ä¸ºäº‹åŠ¡åˆ†é…å…¶å†å²åºåˆ—å·ï¼Œå¹¶æ›´æ–°çš„undoæ—¥å¿—è®°å½•å†™å…¥åˆ†é…çš„å›æ»šæ®µ</span><br><span class="line">  |  |  |  |  |  |  |  |--&gt; mtr_commit </span><br><span class="line">  |  |  |  |  |  |  |  |--&gt; trx_commit_in_memory // Commits a transaction in memory</span><br></pre></td></tr></table></figure>
<ul>
<li>binlogæ—¢æ˜¯äºŒé˜¶æ®µçš„å‚ä¸è€…ï¼Œåˆæ˜¯åè°ƒè€…ï¼Œæ‰€ä»¥åœ¨æºç å®ç°ä¸­å¯ä»¥çœ‹åˆ° prepareé˜¶æ®µ å’Œ commité˜¶æ®µå‡½æ•°å…¥å£éƒ½åœ¨MYSQL_BIN_LOGä¸­ã€‚</li>
<li>å‡†å¤‡é˜¶æ®µï¼štc_log-&gt;prepare()</li>
<li>æäº¤é˜¶æ®µï¼štc_log-&gt;commit()</li>
</ul>
<p><code>ha_commit_trans</code>æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*   </span></span><br><span class="line"><span class="comment">    æäº¤äº‹åŠ¡ã€‚</span></span><br><span class="line"><span class="comment">    serverå±‚æœ€åè°ƒç”¨å‡½æ•° ha_commit_trans(), è¯¥å‡½æ•°è´Ÿè´£å¤„ç† binlog å±‚å’Œå­˜å‚¨å¼•æ“å±‚çš„æäº¤ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ha_commit_trans</span><span class="params">(THD *thd, <span class="type">bool</span> all, <span class="type">bool</span> ignore_global_read_lock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è¯»å†™äº‹åŠ¡ &amp;&amp; ä¸èƒ½å¿½ç•¥å…¨å±€è¯»é”</span></span><br><span class="line">    <span class="keyword">if</span> (rw_trans &amp;&amp; !ignore_global_read_lock)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è·å–ä¸€ä¸ª MDL_KEY::COMMIT å…ƒæ•°æ®é”, è¯¥å…ƒæ•°æ®é”å°†ç¡®ä¿ commit æ“ä½œä¼šè¢«æ´»è·ƒçš„ FTWRL é”é˜»æ­¢ã€‚</span></span><br><span class="line"><span class="comment">        FTWRLé”ä¼šé˜»å¡ COMMIT æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="built_in">MDL_REQUEST_INIT</span>(&amp;mdl_request,</span><br><span class="line">                       MDL_key::COMMIT, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, MDL_INTENTION_EXCLUSIVE,</span><br><span class="line">                       MDL_EXPLICIT);</span><br><span class="line">      <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;debug&quot;</span>, (<span class="string">&quot;Acquire MDL commit lock&quot;</span>));</span><br><span class="line">      <span class="comment">// ç”³è¯· MDL_key::COMMIT é”, ç”³è¯·å¤±è´¥</span></span><br><span class="line">      <span class="keyword">if</span> (thd-&gt;mdl_context.<span class="built_in">acquire_lock</span>(&amp;mdl_request,</span><br><span class="line">                                        thd-&gt;variables.lock_wait_timeout))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">ha_rollback_trans</span>(thd, all);</span><br><span class="line">        <span class="built_in">DBUG_RETURN</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      release_mdl = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¼€å¯ xa äº‹åŠ¡;</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰çš„ entries éƒ½æ”¯æŒ 2pc &amp;&amp; åœ¨äº‹åŠ¡ scope ä¸­è®¾ç½®åšè¯»å†™æ›´æ”¹çš„å¼•æ“æ•°é‡ &gt; 1</span></span><br><span class="line">    <span class="keyword">if</span> (!trn_ctx-&gt;<span class="built_in">no_2pc</span>(trx_scope) &amp;&amp; (trn_ctx-&gt;<span class="built_in">rw_ha_count</span>(trx_scope) &gt; <span class="number">1</span>))</span><br><span class="line">      <span class="comment">// prepare; åœ¨äº‹åŠ¡åè°ƒå™¨ä¸­ prepare commit tx, åœ¨å¼•æ“å±‚ç”Ÿæˆä¸€ä¸ª XA äº‹åŠ¡ã€‚</span></span><br><span class="line">      <span class="comment">// tc_log: mysqldå¯åŠ¨æ—¶ç”Ÿæˆçš„ MySQL_BIN_LOG å¯¹è±¡[XAæ§åˆ¶å¯¹è±¡]ã€‚</span></span><br><span class="line">      error = tc_log-&gt;<span class="built_in">prepare</span>(thd, all);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    XA äº‹åŠ¡çš„çŠ¶æ€å˜æ›´ä¸º prepared, ä¸­é—´æ€ã€‚æœ€ç»ˆä¼šå˜æˆå¸¸è§„çš„ NOTR çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!error &amp;&amp; all &amp;&amp; xid_state-&gt;<span class="built_in">has_state</span>(XID_STATE::XA_IDLE))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">assert</span>(thd-&gt;lex-&gt;sql_command == SQLCOM_XA_COMMIT &amp;&amp;</span><br><span class="line">           <span class="built_in">static_cast</span>&lt;Sql_cmd_xa_commit *&gt;(thd-&gt;lex-&gt;m_sql_cmd)-&gt;<span class="built_in">get_xa_opt</span>() == XA_ONE_PHASE);</span><br><span class="line">    <span class="comment">// è®¾ç½® XA äº‹åŠ¡çŠ¶æ€ä¸º XA_PREPARED çŠ¶æ€ã€‚</span></span><br><span class="line">    xid_state-&gt;<span class="built_in">set_state</span>(XID_STATE::XA_PREPARED);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * XA äº‹åŠ¡æäº¤</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (error || (error = tc_log-&gt;<span class="built_in">commit</span>(thd, all)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ha_rollback_trans</span>(thd, all);</span><br><span class="line">    error = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> end;</span><br><span class="line">  &#125;</span><br><span class="line">end:</span><br><span class="line">  <span class="comment">// é‡Šæ”¾ mdl é”ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (release_mdl &amp;&amp; mdl_request.ticket)</span><br><span class="line">  &#123;</span><br><span class="line">    thd-&gt;mdl_context.<span class="built_in">release_lock</span>(mdl_request.ticket);</span><br><span class="line">  &#125;  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * é‡Šæ”¾èµ„æºå¹¶æ‰§è¡Œå…¶ä»–æ¸…ç†ã€‚ç©ºäº‹åŠ¡ä¹Ÿéœ€è¦ã€‚</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (is_real_trans)</span><br><span class="line">  &#123;</span><br><span class="line">    trn_ctx-&gt;<span class="built_in">cleanup</span>();</span><br><span class="line">    thd-&gt;tx_priority = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="5-3-2ã€Prepare-é˜¶æ®µ"><a href="#5-3-2ã€Prepare-é˜¶æ®µ" class="headerlink" title="5.3.2ã€Prepare é˜¶æ®µ"></a>5.3.2ã€Prepare é˜¶æ®µ</h3><blockquote>
<p><font color="red"><strong>prepareé˜¶æ®µåˆ†ä¸ºbinlogçš„prepareå’Œinnodbçš„prepare</strong></font>ã€‚è¿›å…¥binlogå’Œinnodb prepaeå‰ä¼šè®¾ç½®durability_property &#x3D; HA_IGNORE_DURABILITY, è¡¨ç¤ºåœ¨innodb prepareå’Œfinish_commit()æ—¶ï¼Œä¸åˆ·redo logåˆ°ç£ç›˜ã€‚</p>
</blockquote>
<p>MYSQL_BIN_LOG::prepareçš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MYSQL_BIN_LOG::prepare</span><span class="params">(THD *thd, <span class="type">bool</span> all)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è®¾ç½® HA_IGNORE_DURABILITY åœ¨ prepare é˜¶æ®µä¸å°†äº‹åŠ¡çš„ prepare record åˆ·åˆ° innodb redo logã€‚</span></span><br><span class="line"><span class="comment">    è¿™æ ·åœ¨ binlog ç»„æäº¤çš„ flush é˜¶æ®µ flushing binlog ä¹‹å‰ flush prepare record åˆ° innodb redo logã€‚</span></span><br><span class="line"><span class="comment">    åœ¨ innodb prepare æ—¶, ä¸åˆ· redo log.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  thd-&gt;durability_property = HA_IGNORE_DURABILITY;</span><br><span class="line">  <span class="comment">//  åœ¨å¼•æ“ä¸­ prepare commit trx</span></span><br><span class="line">  <span class="type">int</span> error = <span class="built_in">ha_prepare_low</span>(thd, all);</span><br><span class="line">  <span class="built_in">DBUG_RETURN</span>(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨æˆ·çº¿ç¨‹å¯¹è±¡çš„ durability_property å±æ€§å€¼ä¼šè¢«è®¾ç½®ä¸º HA_IGNORE_DURABILITYã€‚<ul>
<li>è¿™ä¸ªå±æ€§å’Œ redo æ—¥å¿—åˆ·ç›˜æœ‰å…³ï¼ŒInnoDB prepare ä¼šç”¨åˆ°ã€‚</li>
</ul>
</li>
</ul>
<p>ç»§ç»­æ‰§è¡Œ <code>ha_prepare_low</code>å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * prepare commit trx</span></span><br><span class="line"><span class="comment"> * åœ¨å¼•æ“å±‚ prepare commit trx</span></span><br><span class="line"><span class="comment"> * åŒ…æ‹¬ binlogå¼•æ“ å’Œ innodbå¼•æ“</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ha_prepare_low</span><span class="params">(THD *thd, <span class="type">bool</span> all)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// éå†å¼•æ“</span></span><br><span class="line">  <span class="keyword">if</span> (ha_info)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (; ha_info &amp;&amp; !error; ha_info = ha_info-&gt;<span class="built_in">next</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// å¼•æ“</span></span><br><span class="line">      handlerton *ht = ha_info-&gt;<span class="built_in">ht</span>();</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        å¦‚æœè¿™ä¸ªç‰¹å®šäº‹åŠ¡æ˜¯åªè¯»çš„, ä¸è¦è°ƒç”¨ä¸¤é˜¶æ®µæäº¤ã€‚</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (!ha_info-&gt;<span class="built_in">is_trx_read_write</span>())</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * è°ƒç”¨å¼•æ“çš„ prepare åœ¨å­˜å‚¨å±‚ç”Ÿæˆ XA äº‹åŠ¡ã€‚</span></span><br><span class="line"><span class="comment">       * å…ˆ binlog prepare, å† innodb prepare;</span></span><br><span class="line"><span class="comment">       * binlog prepare: å°†ä¸Šä¸€æ¬¡ commit é˜Ÿåˆ—ä¸­æœ€å¤§çš„ seq num å†™å…¥æœ¬æ¬¡äº‹åŠ¡çš„ last_commit ä¸­</span></span><br><span class="line"><span class="comment">       * innodb prepare: åœ¨ innodb ä¸­æ›´æ”¹ undo æ—¥å¿—æ®µçš„çŠ¶æ€ä¸º trx_undo_prepared, å¹¶å°† xid å†™å…¥ undo log headerã€‚</span></span><br><span class="line"><span class="comment">       * */</span></span><br><span class="line">      <span class="keyword">if</span> ((err = ht-&gt;<span class="built_in">prepare</span>(ht, thd, all)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">my_error</span>(ER_ERROR_DURING_COMMIT, <span class="built_in">MYF</span>(<span class="number">0</span>), err);</span><br><span class="line">        error = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ha_prepare_count++</span></span><br><span class="line">      thd-&gt;status_var.ha_prepare_count++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨æ‰§è¡Œæµç¨‹ä¼šæ‰§è¡Œ<code>ht->prepare(ht, thd, all)</code></p>
<ul>
<li><font color="red"><strong>prepareé˜¶æ®µåˆ†ä¸ºbinlogçš„prepareå’Œinnodbçš„prepare.</strong></font></li>
</ul>
<h4 id="ç¬¬ä¸€æ­¥ï¼šBinlog-Prepare"><a href="#ç¬¬ä¸€æ­¥ï¼šBinlog-Prepare" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šBinlog Prepare"></a>ç¬¬ä¸€æ­¥ï¼šBinlog Prepare</h4><p>binlog è¢«çœ‹ä½œä¸€ç§å­˜å‚¨å¼•æ“ï¼Œå®ƒä¹Ÿæœ‰ prepare é˜¶æ®µï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sql/binlog.cc</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binlog_prepare</span><span class="params">(handlerton *, THD *thd, <span class="type">bool</span> all)</span> </span>&#123;</span><br><span class="line">  DBUG_TRACE;</span><br><span class="line">  <span class="keyword">if</span> (!all) &#123;</span><br><span class="line">    thd-&gt;<span class="built_in">get_transaction</span>()-&gt;<span class="built_in">store_commit_parent</span>(</span><br><span class="line">        mysql_bin_log.m_dependency_tracker.<span class="built_in">get_max_committed_timestamp</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>äºŒé˜¶æ®µæäº¤æ—¶</p>
<ul>
<li>all &#x3D; trueï¼Œä¸ä¼šå‘½ä¸­åˆ†æ”¯ if (!all)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ prepare é˜¶æ®µï¼Œbinlog ä»€ä¹ˆä¹Ÿä¸ä¼šå¹²ã€‚</li>
<li>å¯¹äºallä¸ºfalseçš„äº‹åŠ¡ï¼Œä¼šæ›´æ–°è¯¥äº‹åŠ¡çš„last_commitedä¸ºæ­¤æ—¶most recently commitedäº‹åŠ¡çš„sequence_numberï¼Œsequence_numberæ˜¯Binlogæäº¤çš„é€»è¾‘æ—¶é—´æˆ³ï¼Œå¯ç”¨äºåœ¨slaveèŠ‚ç‚¹ä¸Šå¹¶è¡Œæ‰§è¡ŒBinlogäº‹åŠ¡ï¼Œç”Ÿæˆå’Œè‡ªå¢ç­–ç•¥å‚è€ƒBinlogäº‹åŠ¡ä¾èµ–ç­–ç•¥ã€‚</li>
</ul>
<h4 id="ç¬¬äºŒæ­¥ï¼šInnoDB-Prepare"><a href="#ç¬¬äºŒæ­¥ï¼šInnoDB-Prepare" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šInnoDB Prepare"></a>ç¬¬äºŒæ­¥ï¼šInnoDB Prepare</h4><p>innodb prepareé˜¶æ®µå †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">innobase_xa_prepare()                             # innodb prepapre</span><br><span class="line">| ...</span><br><span class="line">|- trx_prepare_for_mysql()</span><br><span class="line">|  |- trx_prepare()</span><br><span class="line">|  |  |- trx_prepare_low()</span><br><span class="line">|  |  |  |- mtr_t::startï¼ˆï¼‰                      # å¼€å¯ä¸€ä¸ªmini-transaction</span><br><span class="line">|  |  |  |- mtr_t::commit()                      # é€šè¿‡mtr,å†™redoåˆ°redo log buffer</span><br><span class="line">|  |  |  |  |- Command::execute()</span><br><span class="line">|  |  |  |  |  |- prepare_write()                # å‡†å¤‡å†™mtr logåˆ°redo-log buffer</span><br><span class="line">|  |  |  |  |  |- finish_write()</span><br><span class="line">|  |  |- trx-&gt;state = TRX_STATE_PREPARED</span><br></pre></td></tr></table></figure>
<p>å¹¶æ²¡æœ‰å†™redo logåˆ°æ–‡ä»¶ä¸­ï¼Œé™¤éredo log bufferç©ºé—´ä¸è¶³ã€‚ä»¥ä¸‹å¯çœ‹å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">finish_write()</span><br><span class="line">| ...</span><br><span class="line">|- log_reserve_and_open()</span><br><span class="line">|  |- # not enough space,do a write of buffer</span><br><span class="line">|  |- log_buffer_sync_in_background(false)       # not enough space,do a write of buffer</span><br><span class="line">|  |  |- log_write_up_to(lsn, false)             # write to redo log file,æ²¡æœ‰æ‰§è¡Œfsync</span><br><span class="line">|  |  |  |- log_group_write_buf()                # Writes a buffer to a log file group</span><br><span class="line">|...</span><br><span class="line">|- mtr_write_log_t::operator()                   # append blocks to redo log buffer</span><br><span class="line">|  |- log_write_low()                            # å†™ redo log block åˆ° redo log buffer</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œprepareé˜¶æ®µå¹¶æ²¡æœ‰å†™redo logåˆ°æ–‡ä»¶ä¸­ï¼Œåªæœ‰ä¸€ç§æƒ…å†µä¼šå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œé‚£å°±æ˜¯redo log bufferç©ºé—´ä¸è¶³æ—¶ï¼Œå¹¶ä¸”è¿™é‡Œåªæ˜¯å†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œå¹¶ä¸æ‰§è¡Œflushæ“ä½œã€‚</p>
<blockquote>
<p>äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µï¼ŒInnoDB ä¸»è¦åšäº”ä»¶äº‹ã€‚</p>
<p><strong>ç¬¬ 1 ä»¶</strong>ï¼ŒæŠŠåˆ†é…ç»™äº‹åŠ¡çš„æ‰€æœ‰ undo æ®µçš„çŠ¶æ€ä» TRX_UNDO_ACTIVE ä¿®æ”¹ä¸º TRX_UNDO_PREPAREDã€‚<br>è¿›å…¥äºŒé˜¶æ®µæäº¤çš„äº‹åŠ¡ï¼Œéƒ½è‡³å°‘æ”¹å˜è¿‡ï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰ä¸€ä¸ªç”¨æˆ·è¡¨çš„ä¸€æ¡è®°å½•ï¼Œæœ€å°‘ä¼šåˆ†é… 1 ä¸ª undo æ®µï¼Œæœ€å¤šä¼šåˆ†é… 4 ä¸ª undo æ®µã€‚<br>å…·ä½“ä»€ä¹ˆæƒ…å†µåˆ†é…å¤šå°‘ä¸ª undo æ®µï¼Œåç»­å…³äº undo æ¨¡å—çš„æ–‡ç« ä¼šæœ‰è¯¦ç»†ä»‹ç»ã€‚<br>ä¸ç®¡ InnoDB ç»™äº‹åŠ¡åˆ†é…äº†å‡ ä¸ª undo æ®µï¼Œå®ƒä»¬çš„çŠ¶æ€éƒ½ä¼šè¢«ä¿®æ”¹ä¸º TRX_UNDO_PREPAREDã€‚<br><strong>ç¬¬ 2 ä»¶</strong>ï¼ŒæŠŠäº‹åŠ¡ Xid å†™å…¥æ‰€æœ‰ undo æ®µä¸­å½“å‰æäº¤äº‹åŠ¡çš„ undo æ—¥å¿—ç»„å¤´ä¿¡æ¯ã€‚<br>InnoDB ç»™å½“å‰æäº¤äº‹åŠ¡åˆ†é…çš„æ¯ä¸ª undo æ®µä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ç»„ undo æ—¥å¿—å±äºè¿™ä¸ªäº‹åŠ¡ï¼Œäº‹åŠ¡ Xid å°±å†™å…¥ undo æ—¥å¿—ç»„çš„å¤´ä¿¡æ¯ã€‚<br>å¯¹äºç¬¬ 1ã€2 ä»¶äº‹ï¼Œå¦‚æœäº‹åŠ¡æ”¹å˜äº†ç”¨æˆ·æ™®é€šè¡¨çš„æ•°æ®ï¼Œä¿®æ”¹ undo æ®µçŠ¶æ€ã€æŠŠäº‹åŠ¡ Xid å†™å…¥ undo æ—¥å¿—ç»„å¤´ä¿¡æ¯ï¼Œéƒ½ä¼šäº§ç”Ÿ redo æ—¥å¿—ã€‚<br><strong>ç¬¬ 3 ä»¶</strong>ï¼ŒæŠŠå†…å­˜ä¸­çš„äº‹åŠ¡å¯¹è±¡çŠ¶æ€ä» TRX_STATE_ACTIVE ä¿®æ”¹ä¸º TRX_STATE_PREPAREDã€‚<br>å‰é¢ä¿®æ”¹ undo çŠ¶æ€ï¼Œæ˜¯ä¸ºäº†äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰ï¼ŒMySQL å´©æºƒäº†ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ï¼Œèƒ½å¤Ÿä» undo æ®µä¸­æ¢å¤å´©æºƒä¹‹å‰çš„äº‹åŠ¡çŠ¶æ€ã€‚<br>è¿™é‡Œä¿®æ”¹äº‹åŠ¡å¯¹è±¡çŠ¶æ€ï¼Œç”¨äº MySQL æ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ‡è¯†äº‹åŠ¡å·²ç»è¿›å…¥äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µã€‚<br><strong>ç¬¬ 4 ä»¶</strong>ï¼Œå¦‚æœå½“å‰æäº¤äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯è¯»æœªæäº¤ï¼ˆREAD-UNCOMMITTEDï¼‰æˆ–è¯»å·²æäº¤ï¼ˆREAD-COMMITTED)ï¼ŒInnoDB ä¼šé‡Šæ”¾äº‹åŠ¡ç»™è®°å½•åŠ çš„å…±äº«ã€æ’ä»– GAP é”ã€‚<br>è™½ç„¶è¯»æœªæäº¤ã€è¯»å·²æäº¤éš”ç¦»çº§åˆ«ä¸€èˆ¬éƒ½åªåŠ æ™®é€šè®°å½•é”ï¼Œä¸åŠ  GAP é”ï¼Œä½†æ˜¯ï¼Œå¤–é”®çº¦æŸæ£€æŸ¥ã€æ’å…¥è®°å½•é‡å¤å€¼æ£€æŸ¥è¿™ä¸¤ä¸ªåœºæ™¯ä¸‹ï¼Œè¿˜æ˜¯ä¼šç»™ç›¸åº”çš„è®°å½•åŠ  GAP é”ã€‚<br><strong>ç¬¬ 5 ä»¶</strong>ï¼Œè°ƒç”¨ trx_flush_logs()ï¼Œå¤„ç† redo æ—¥å¿—åˆ·ç›˜çš„ç›¸å…³é€»è¾‘ã€‚</p>
</blockquote>
<p>Innodb prepare ä¸€ä¸ª X&#x2F;Open XA åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************/</span> <span class="comment">/**</span></span><br><span class="line"><span class="comment">static int innobase_xa_prepare(</span></span><br><span class="line"><span class="comment">        /*================*/</span></span><br><span class="line">        handlerton *hton, <span class="comment">/*!&lt; in: InnoDB handlerton ; innodbå¼•æ“ */</span></span><br><span class="line">        THD *thd,                   <span class="comment">/*!&lt; in: handle to the MySQL thread of</span></span><br><span class="line"><span class="comment">                    the user whose XA transaction should</span></span><br><span class="line"><span class="comment">                    be prepared ; mysqlçº¿ç¨‹ */</span></span><br><span class="line">        <span class="type">bool</span> prepare_trx) <span class="comment">/*!&lt; in: true - prepare transaction</span></span><br><span class="line"><span class="comment">                    false - the current SQL statement</span></span><br><span class="line"><span class="comment">                    ended ; true: prepare äº‹åŠ¡</span></span><br><span class="line"><span class="comment">                            false: å½“å‰ SQL è¯­å¥ç»“æŸ, è¯­å¥çº§åˆ«çš„æäº¤ */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// trx</span></span><br><span class="line">    <span class="type">trx_t</span> *trx = <span class="built_in">check_trx_exists</span>(thd);</span><br><span class="line">    <span class="comment">// è·å–thdçš„ xid, åŒæ—¶è®¾ç½®åˆ° trx -&gt; xid ä¸­</span></span><br><span class="line">    <span class="built_in">thd_get_xid</span>(thd, (MYSQL_XID *)trx-&gt;xid);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* é‡Šæ”¾å¯èƒ½çš„ FIFO ticket å’Œ search latchã€‚</span></span><br><span class="line"><span class="comment">    å› ä¸ºæˆ‘ä»¬è¦ä¿ç•™ trx_sys -&gt; mutex, æˆ‘ä»¬å¿…é¡»é¦–å…ˆé‡Šæ”¾ search system latch æ¥éµå®ˆé”å­˜é¡ºåºã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">trx_search_latch_release_if_reserved</span>(trx);</span><br><span class="line">    <span class="comment">// prepare trx</span></span><br><span class="line">    <span class="keyword">if</span> (prepare_trx || (!<span class="built_in">thd_test_options</span>(thd, OPTION_NOT_AUTOCOMMIT | OPTION_BEGIN)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* preapre æ•´ä¸ªäº‹åŠ¡, æˆ–è€…è¿™æ˜¯ä¸€ä¸ªSQLè¯­å¥ç»“æŸ, autocommit æ˜¯æ‰“å¼€çŠ¶æ€ */</span></span><br><span class="line">        <span class="comment">// äº‹åŠ¡å·²ç»åœ¨ mysql 2pc åè°ƒå™¨ä¸­æ³¨å†Œã€‚</span></span><br><span class="line">        <span class="built_in">ut_ad</span>(<span class="built_in">trx_is_registered_for_2pc</span>(trx));</span><br><span class="line">        <span class="comment">// trx prepare</span></span><br><span class="line">        <span class="type">dberr_t</span> err = <span class="built_in">trx_prepare_for_mysql</span>(trx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* è¯­å¥çš„æäº¤åŠ¨ä½œ, è€ŒéçœŸæ­£çš„äº‹åŠ¡æäº¤ã€‚ */</span></span><br><span class="line">        <span class="comment">// éœ€è¦é‡Šæ”¾è¯­å¥ hold çš„ auto_increment é”</span></span><br><span class="line">        <span class="built_in">lock_unlock_table_autoinc</span>(trx);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// è®°å½•æœ¬è¯­å¥çš„ undo ä¿¡æ¯, ä»¥ä¾¿è¯­å¥çº§çš„å›æ»š</span></span><br><span class="line">        <span class="comment">// æ ‡è®°æœ€æ–°SQLè¯­å¥ç»“æŸã€‚</span></span><br><span class="line">        <span class="built_in">trx_mark_sql_stat_end</span>(trx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‰§è¡Œ<code>trx_prepare_for_mysqlï¼š</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * trx prepare</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">dberr_t</span></span></span><br><span class="line"><span class="function"><span class="title">trx_prepare_for_mysql</span><span class="params">(<span class="type">trx_t</span> *trx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    trx-&gt;op_info = <span class="string">&quot;preparing&quot;</span>;</span><br><span class="line">    <span class="comment">// prepare trx.</span></span><br><span class="line">    <span class="built_in">trx_prepare</span>(trx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‰§è¡Œ<code>trx_prepare:</code></p>
<ul>
<li>è½¬æ¢äº‹ç‰©çŠ¶æ€ä¸ºï¼Œäº‹ç‰©çŠ¶æ€ç”± active å˜ä¸º prepare</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************/</span> <span class="comment">/**</span></span><br><span class="line"><span class="comment">prepare trx.*/</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">trx_prepare</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">/*========*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">trx_t</span> *trx)</span> <span class="comment">/*!&lt; in/out: transaction */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å›æ»šæ®µ != NULL &amp;&amp; redo æ®µè¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">if</span> (trx-&gt;rsegs.m_redo.rseg != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">trx_is_redo_rseg_updated</span>(trx))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¸ºæŒ‡å®šçš„å›æ»šæ®µ preapre ä¸€ä¸ªäº‹åŠ¡ã€‚lsn ä¸ºå½“å‰å·² commit çš„ lsn</span></span><br><span class="line">        lsn = <span class="built_in">trx_prepare_low</span>(trx, &amp;trx-&gt;rsegs.m_redo, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (trx-&gt;rsegs.m_noredo.rseg != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">trx_is_noredo_rseg_updated</span>(trx))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¸ºæŒ‡å®šçš„å›æ»šæ®µ preapre ä¸€ä¸ªäº‹åŠ¡ã€‚</span></span><br><span class="line">        <span class="built_in">trx_prepare_low</span>(trx, &amp;trx-&gt;rsegs.m_noredo, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*--------------------------------------*/</span></span><br><span class="line">    <span class="comment">// äº‹åŠ¡çŠ¶æ€ä¸º TRX_STATE_ACTIVE çŠ¶æ€, ä¿®æ”¹äº‹åŠ¡çŠ¶æ€</span></span><br><span class="line">    trx-&gt;state = TRX_STATE_PREPARED;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡ç³»ç»Ÿä¸­å¤„äº xa prepared çŠ¶æ€çš„äº‹åŠ¡çš„æ•°é‡</span></span><br><span class="line">    trx_sys-&gt;n_prepared_trx++;</span><br><span class="line">    <span class="comment">/*--------------------------------------*/</span></span><br><span class="line">    <span class="comment">/* Release read locks after PREPARE for READ COMMITTED</span></span><br><span class="line"><span class="comment">    and lower isolation.</span></span><br><span class="line"><span class="comment">    å¯¹ rc éš”ç¦»çº§åˆ«, åœ¨ prepare ä¹‹åé‡Šæ”¾ read locks, é™ä½éš”ç¦»åº¦</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (trx-&gt;isolation_level &lt;= TRX_ISO_READ_COMMITTED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Stop inheriting GAP locks.</span></span><br><span class="line"><span class="comment">        åœæ­¢ç»§æ‰¿ GAP lockã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        trx-&gt;skip_lock_inheritance = <span class="literal">true</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/* Release only GAP locks for now.</span></span><br><span class="line"><span class="comment">        é‡Šæ”¾ GAP lockã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="built_in">lock_trx_release_read_locks</span>(trx, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">thd_requested_durability</span>(trx-&gt;mysql_thd))</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> HA_IGNORE_DURABILITY:</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        åœ¨ binlog group commit çš„ prepare é˜¶æ®µ, æˆ‘ä»¬è®¾ç½® HA_IGNORE_DURABILITY , è¿™æ ·åœ¨è¿™ä¸ªé˜¶æ®µä¸ä¼š flush redo logã€‚</span></span><br><span class="line"><span class="comment">        è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ binlog group commit çš„ flush é˜¶æ®µåœ¨å°† binary logå†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ä¹‹å‰, åœ¨ä¸€ä¸ªç»„ä¸­ flush redo logã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ..</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‰§è¡Œ <code>trx_prepare_low</code>ï¼Œä¸ºæŒ‡å®šçš„å›æ»šæ®µ preapre ä¸€ä¸ªäº‹åŠ¡ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************/</span> <span class="comment">/**</span></span><br><span class="line"><span class="comment">ä¸ºæŒ‡å®šçš„å›æ»šæ®µ preapre ä¸€ä¸ªäº‹åŠ¡ã€‚ */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">lsn_t</span></span></span><br><span class="line"><span class="function"><span class="title">trx_prepare_low</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">/*============*/</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">trx_t</span> *trx,                             <span class="comment">/*!&lt; in/out: transaction */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">trx_undo_ptr_t</span> *undo_ptr, <span class="comment">/*!&lt; in/out: pointer to rollback</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">                    segment scheduled for prepare. æŒ‡å‘å›æ»šæ®µçš„æŒ‡é’ˆ */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">bool</span> noredo_logging)</span>            <span class="comment">/*!&lt; in: turn-off redo logging. ä¸éœ€è¦redo log */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">lsn_t</span> lsn;</span><br><span class="line">    <span class="comment">// insert æˆ–è€… undo å›æ»šæ®µä¸ä¸º NULL</span></span><br><span class="line">    <span class="keyword">if</span> (undo_ptr-&gt;insert_undo != <span class="literal">NULL</span> || undo_ptr-&gt;update_undo != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// start a sync mtr</span></span><br><span class="line">        <span class="built_in">mtr_start_sync</span>(&amp;mtr);</span><br><span class="line">        <span class="comment">// è®¾ç½® mtr mode</span></span><br><span class="line">        <span class="keyword">if</span> (noredo_logging)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">mtr_set_log_mode</span>(&amp;mtr, MTR_LOG_NO_REDO);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        å°†  undo æ—¥å¿—æ®µçŠ¶æ€ä» trx_undo_active ä¿®æ”¹ä¸º trx_undo_prepared:</span></span><br><span class="line"><span class="comment">        æ›´æ”¹ undo å›æ»šæ®µå°†å…¶è®¾ç½®ä¸º prepare çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="built_in">mutex_enter</span>(&amp;rseg-&gt;mutex);</span><br><span class="line">        <span class="comment">// insert undo log ä¸ä¸º NULL</span></span><br><span class="line">        <span class="keyword">if</span> (undo_ptr-&gt;insert_undo != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            è¿™é‡Œä¸éœ€è¦è·å– trx-&gt;undo_mutex, å› ä¸ºåªå…è®¸ä¸€ä¸ª OS çº¿ç¨‹ä¸ºè¯¥äº‹åŠ¡åšäº‹åŠ¡å‡†å¤‡ã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">// å°† undo æ—¥å¿—æ®µçŠ¶æ€ä» trx_undo_active ä¿®æ”¹ä¸º trx_undo_prepared çŠ¶æ€</span></span><br><span class="line">            <span class="built_in">trx_undo_set_state_at_prepare</span>(</span><br><span class="line">                    trx, undo_ptr-&gt;insert_undo, <span class="literal">false</span>, &amp;mtr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°† undo æ—¥å¿—æ®µçŠ¶æ€ä» trx_undo_active ä¿®æ”¹ä¸º trx_undo_prepared çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (undo_ptr-&gt;update_undo != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">trx_undo_set_state_at_prepare</span>(</span><br><span class="line">                    trx, undo_ptr-&gt;update_undo, <span class="literal">false</span>, &amp;mtr);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">mutex_exit</span>(&amp;rseg-&gt;mutex);</span><br><span class="line">        lsn = mtr.<span class="built_in">commit_lsn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        lsn = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (lsn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‰§è¡Œ<code>trx_undo_set_state_at_prepare</code>ï¼Œä¿®æ”¹ undo æ—¥å¿—æ®µçš„çŠ¶æ€ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¿®æ”¹ undo æ—¥å¿—æ®µçš„çŠ¶æ€*/</span></span><br><span class="line"><span class="function"><span class="type">page_t</span> *</span></span><br><span class="line"><span class="function"><span class="title">trx_undo_set_state_at_prepare</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">trx_t</span> *trx,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">trx_undo_t</span> *undo,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">bool</span> rollback,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">mtr_t</span> *mtr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è·å– undo page é¡µ, å¹¶åœ¨å…¶ä¸ŠåŠ  x-latch</span></span><br><span class="line">    undo_page = <span class="built_in">trx_undo_page_get</span>(</span><br><span class="line">            <span class="built_in">page_id_t</span>(undo-&gt;space, undo-&gt;hdr_page_no),</span><br><span class="line">            undo-&gt;page_size, mtr);</span><br><span class="line">    <span class="comment">// undo æ®µ header</span></span><br><span class="line">    seg_hdr = undo_page + TRX_UNDO_SEG_HDR;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ XA rollback</span></span><br><span class="line">    <span class="keyword">if</span> (rollback)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ut_ad</span>(undo-&gt;state == TRX_UNDO_PREPARED);</span><br><span class="line">        <span class="comment">// å°† undo æ®µçš„çŠ¶æ€ä» TRX_UNDO_PREPARED ä¿®æ”¹ä¸º TRX_UNDO_ACTIVE çŠ¶æ€</span></span><br><span class="line">        <span class="built_in">mlog_write_ulint</span>(seg_hdr + TRX_UNDO_STATE, TRX_UNDO_ACTIVE,</span><br><span class="line">                                         MLOG_2BYTES, mtr);</span><br><span class="line">        <span class="keyword">return</span> (undo_page);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*------------------------------*/</span></span><br><span class="line">    <span class="comment">// æ˜¯ XA prepare, åˆ™å°† undo æ®µçš„çŠ¶æ€ä» TRX_UNDO_ACTIVE ä¿®æ”¹ä¸º TRX_UNDO_PREPARED, å¹¶å°† xid å†™å…¥ undoã€‚</span></span><br><span class="line">    <span class="built_in">ut_ad</span>(undo-&gt;state == TRX_UNDO_ACTIVE);</span><br><span class="line">    undo-&gt;state = TRX_UNDO_PREPARED;</span><br><span class="line">    undo-&gt;xid = *trx-&gt;xid;</span><br><span class="line">    <span class="comment">/*------------------------------*/</span></span><br><span class="line">    <span class="comment">// åœ¨ undo æ®µä¸­æ›´æ–°å½“å‰ undo æ®µçš„çŠ¶æ€</span></span><br><span class="line">    <span class="built_in">mlog_write_ulint</span>(seg_hdr + TRX_UNDO_STATE, undo-&gt;state,</span><br><span class="line">                                     MLOG_2BYTES, mtr);</span><br><span class="line">    <span class="comment">// åœ¨ undo æ®µ last undo log header ä¸­å†™å…¥ xid</span></span><br><span class="line">    offset = <span class="built_in">mach_read_from_2</span>(seg_hdr + TRX_UNDO_LAST_LOG);</span><br><span class="line">    undo_header = undo_page + offset;</span><br><span class="line">    <span class="built_in">mlog_write_ulint</span>(undo_header + TRX_UNDO_XID_EXISTS,</span><br><span class="line">                                     TRUE, MLOG_1BYTE, mtr);</span><br><span class="line">    <span class="built_in">trx_undo_write_xid</span>(undo_header, &amp;undo-&gt;xid, mtr);</span><br><span class="line">    <span class="keyword">return</span> (undo_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="5-3-3ã€Commit-é˜¶æ®µ"><a href="#5-3-3ã€Commit-é˜¶æ®µ" class="headerlink" title="5.3.3ã€Commit é˜¶æ®µ"></a>5.3.3ã€Commit é˜¶æ®µ</h3><p>æ–‡ç« çš„ä¹¦å†™é¡ºåºæ˜¯å…ˆäº†è§£æ•´ä½“é€»è¾‘ï¼Œå†åˆ†ææºç åˆ†æã€‚</p>
<h4 id="5-3-3-1ã€é€»è¾‘åˆ†æ"><a href="#5-3-3-1ã€é€»è¾‘åˆ†æ" class="headerlink" title="5.3.3.1ã€é€»è¾‘åˆ†æ"></a>5.3.3.1ã€é€»è¾‘åˆ†æ</h4><p>äºŒé˜¶æ®µæäº¤çš„ commit é˜¶æ®µåˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼šflush å­é˜¶æ®µã€sync å­é˜¶æ®µã€commit å­é˜¶æ®µã€‚</p>
<h5 id="Stage-0-é˜¶æ®µ"><a href="#Stage-0-é˜¶æ®µ" class="headerlink" title="Stage 0 é˜¶æ®µ"></a>Stage 0 é˜¶æ®µ</h5><p>ä¸»è¦æ˜¯ 8.0 æ–°å¢çš„ä¸€ä¸ªé˜¶æ®µï¼Œä¸»è¦æ˜¯é’ˆå¯¹ä»åº“ä¿è¯ commit orderï¼ˆé¡ºåºæäº¤ï¼‰ã€‚</p>
<h5 id="Flush-å­é˜¶æ®µ"><a href="#Flush-å­é˜¶æ®µ" class="headerlink" title="Flush å­é˜¶æ®µ"></a>Flush å­é˜¶æ®µ</h5><ol>
<li>æ ¹æ® <code>innodb_flush_log_at_trx_commit</code> å‚æ•°è¿›è¡Œ redo log çš„åˆ·ç›˜æ“ä½œ<ul>
<li>è·å–å¹¶æ¸…ç©º BINLOG_FLUSH_STAGE å’Œ COMMIT_ORDER_FLUSH_STAGE é˜Ÿåˆ—</li>
<li>å­˜å‚¨å¼•æ“å±‚å°† prepare çŠ¶æ€çš„ redo log æ ¹æ® <code>innodb_flush_log_at_trx_commit</code> å‚æ•°åˆ·ç›˜</li>
<li>ä¸å†é˜»å¡ slave çš„ preserve commit order çš„æ‰§è¡Œ</li>
</ul>
</li>
<li>è°ƒç”¨ get_server_sidno() å’Œ Gtid_state::get_automatic_gno() ç”Ÿæˆ GTID</li>
<li>Flush binlog_cache_mngr<ul>
<li>Flush stmt_cache</li>
<li>Flush trx_cache<ul>
<li>ç”Ÿæˆ last_committed å’Œ sequence_number</li>
<li>flush GTID log event</li>
<li>å°† trx_cache ä¸­çš„æ•°æ® flush åˆ° binlog cache ä¸­</li>
<li>å‡†å¤‡æäº¤äº‹åŠ¡åçš„ Binlog pos</li>
<li>é€’å¢ prepread XID</li>
</ul>
</li>
</ul>
</li>
<li>æ’æ¡©è°ƒç”¨after_flushï¼Œå°†å·²ç» flush çš„ binlog file å’Œ position æ³¨å†Œåˆ°åŠåŒæ­¥å¤åˆ¶æ’ä»¶ä¸­</li>
<li>å¦‚æœ sync_binlog!&#x3D;1ï¼Œåœ¨ flush stage æ›´æ–° Binlog ä½ç‚¹ï¼Œå¹¶å¹¿æ’­ update ä¿¡å·ï¼Œä»åº“çš„ Dump çº¿ç¨‹å¯ä»¥ç”±æ­¤æ„ŸçŸ¥ Binlog çš„æ›´æ–°</li>
</ol>
<h5 id="Sync-å­é˜¶æ®µ"><a href="#Sync-å­é˜¶æ®µ" class="headerlink" title="Sync å­é˜¶æ®µ"></a>Sync å­é˜¶æ®µ</h5><ol>
<li>æ ¹æ® <code>sync_binlog</code> çš„å‚æ•°è®¾ç½®è¿›è¡Œåˆ·ç›˜å‰çš„ç­‰å¾…å¹¶è°ƒç”¨ fsync() è¿›è¡Œåˆ·ç›˜</li>
<li>å¦‚æœ <code>sync_binlog==1</code>ï¼Œåœ¨ sync stage é˜¶æ®µæ›´æ–° binog ä½ç‚¹ï¼Œå¹¶å¹¿æ’­ update ä¿¡å·ï¼Œä»åº“çš„ Dump çº¿ç¨‹å¯ä»¥ç”±æ­¤æ„ŸçŸ¥ Binlog çš„æ›´æ–°</li>
</ol>
<h5 id="Commit-å­é˜¶æ®µ"><a href="#Commit-å­é˜¶æ®µ" class="headerlink" title="Commit å­é˜¶æ®µ"></a>Commit å­é˜¶æ®µ</h5><ol>
<li>after_sync hookï¼ˆåŠåŒæ­¥å¤åˆ¶ after_sync çš„é’©å­ï¼‰</li>
<li>æ›´æ–°å…¨å±€çš„ m_max_committed_transactionï¼ˆç”¨ä½œåç»­äº‹åŠ¡çš„ last_committedï¼‰ï¼Œå¹¶åˆå§‹åŒ–äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ sequence number</li>
<li>Binlog å±‚æäº¤ï¼Œä»€ä¹ˆä¹Ÿä¸åš</li>
<li>å­˜å‚¨å¼•æ“å±‚æäº¤<ul>
<li>ä¸ºæŒä¹…åŒ– GTID æå‰åˆ†é… update undo segment</li>
<li>æ›´æ–°æ•°æ®å­—å…¸ä¸­è¢«ä¿®æ”¹è¡¨çš„ update_time æ—¶é—´</li>
<li>åˆ†é… Mini-transaction handleå’Œbuffer</li>
<li>æ›´æ–° undo çŠ¶æ€<ul>
<li>å¯¹äº insert çŠ¶æ€ä» TRX_UNDO_ACTIVE  ä¿®æ”¹ä¸º TRX_UNDO_TO_FREEï¼Œupdate ä¿®æ”¹ä¸º TRX_UNDO_TO_PURGE</li>
<li>å¦‚æœäº‹åŠ¡ä¸º update è¿˜éœ€è¦å°† rollback segments åˆ†é… trx noï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° purge é˜Ÿåˆ—ä¸­</li>
</ul>
</li>
<li>å°† update undo log header æ·»åŠ åˆ° history list å¼€å¤´é‡Šæ”¾ä¸€äº›å†…å­˜å¯¹è±¡</li>
<li>åœ¨ç³»ç»Ÿäº‹åŠ¡è¡¨è®°å½• binlog ä½ç‚¹</li>
<li>å…³é—­ mvcc read view</li>
<li>æŒä¹…åŒ– GTID</li>
<li>é‡Šæ”¾insert undo log</li>
<li>å”¤é†’åå°çº¿ç¨‹å¼€å§‹å¹²æ´»ï¼Œå¦‚ master threadã€purge threadã€page_cleaner</li>
</ul>
</li>
<li>æ›´æ–°æ•´ç»„äº‹åŠ¡çš„ executed_gtid</li>
<li>åœ¨å­˜å‚¨å¼•æ“å±‚æäº¤ä¹‹åï¼Œé€’å‡ Prepared çŠ¶æ€ä¸‹çš„ XID è®¡æ•°å™¨</li>
<li>after_sync hookï¼ˆåŠåŒæ­¥å¤åˆ¶ after_commitçš„é’©å­ï¼‰</li>
<li>å¹¿æ’­ m_stage_cond_binlog ä¿¡å·å˜é‡ï¼Œå”¤é†’æŒ‚èµ·çš„ follower</li>
</ol>
<h4 id="5-3-3-2ã€æºç åˆ†æ"><a href="#5-3-3-2ã€æºç åˆ†æ" class="headerlink" title="5.3.3.2ã€æºç åˆ†æ"></a>5.3.3.2ã€æºç åˆ†æ</h4><p>äº†è§£å®Œæ•´ä½“é€»è¾‘ï¼Œå¯¹æºç åˆ†ææ„Ÿå…´è¶£çš„è¯·ç»§ç»­å¾€ä¸‹ã€‚</p>
<p>Commit é˜¶æ®µçš„åŠŸèƒ½å®ç°ä¸»è¦é›†ä¸­åœ¨ <code>MYSQL_BIN_LOG::ordered_commit</code> å‡½æ•°ä¸­ã€‚</p>
<h5 id="Flush-é˜¶æ®µ"><a href="#Flush-é˜¶æ®µ" class="headerlink" title="Flush é˜¶æ®µ"></a>Flush é˜¶æ®µ</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MYSQL_BIN_LOG::ordered_commit</span><span class="params">(THD *thd, <span class="type">bool</span> all, <span class="type">bool</span> skip_commit)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Stage #0: ä¿è¯ä»å®ä¾‹çš„ SQL çº¿ç¨‹æŒ‰ç…§ Relay log çš„äº‹åŠ¡é¡ºåºè¿›è¡Œæäº¤</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (Commit_order_manager::<span class="built_in">wait_for_its_turn_before_flush_stage</span>(thd) ||</span><br><span class="line">      <span class="built_in">ending_trans</span>(thd, all) ||</span><br><span class="line">      Commit_order_manager::<span class="built_in">get_rollback_status</span>(thd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Commit_order_manager::<span class="built_in">wait</span>(thd)) &#123;</span><br><span class="line">      <span class="keyword">return</span> thd-&gt;commit_error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Stage #1: flushing transactions to binary log</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">    While flushing, we allow new threads to enter and will process</span></span><br><span class="line"><span class="comment">    them in due time. Once the queue was empty, we cannot reap</span></span><br><span class="line"><span class="comment">    anything more since it is possible that a thread entered and</span></span><br><span class="line"><span class="comment">    appointed itself leader for the flush phase.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">change_stage</span>(thd, Commit_stage_manager::BINLOG_FLUSH_STAGE, thd, <span class="literal">nullptr</span>,</span><br><span class="line">                   &amp;LOCK_log)) &#123;</span><br><span class="line">    <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;return&quot;</span>, (<span class="string">&quot;Thread ID: %u, commit_error: %d&quot;</span>, thd-&gt;<span class="built_in">thread_id</span>(),</span><br><span class="line">                          thd-&gt;commit_error));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">finish_commit</span>(thd);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  THD *wait_queue = <span class="literal">nullptr</span>, *final_queue = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">mysql_mutex_t</span> *leave_mutex_before_commit_stage = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">my_off_t</span> flush_end_pos = <span class="number">0</span>;</span><br><span class="line">  <span class="type">bool</span> update_binlog_end_pos_after_sync;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Flush é˜¶æ®µä¸»è¦çš„å¤„ç†é€»è¾‘</span></span><br><span class="line">  flush_error =</span><br><span class="line">      <span class="built_in">process_flush_stage_queue</span>(&amp;total_bytes, &amp;do_rotate, &amp;wait_queue);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (flush_error == <span class="number">0</span> &amp;&amp; total_bytes &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      flush binlog cacheåˆ°file cache</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    flush_error = <span class="built_in">flush_cache_to_file</span>(&amp;flush_end_pos);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// åé¢æ ¹æ® sync_binlog å‚æ•°å†³å®šæ›´æ–° binlog pos çš„ä½ç½®å¹¶å¹¿æ’­ Binlog æ›´æ–°ä¿¡å·</span></span><br><span class="line">  update_binlog_end_pos_after_sync = (<span class="built_in">get_sync_period</span>() == <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the flush finished successfully, we can call the after_flush</span></span><br><span class="line"><span class="comment">    hook. Being invoked here, we have the guarantee that the hook is</span></span><br><span class="line"><span class="comment">    executed before the before/after_send_hooks on the dump thread</span></span><br><span class="line"><span class="comment">    preventing race conditions among these plug-ins.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (flush_error == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *file_name_ptr = log_file_name + <span class="built_in">dirname_length</span>(log_file_name);</span><br><span class="line">    <span class="built_in">assert</span>(flush_end_pos != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      æ’æ¡©è°ƒç”¨ after_flushï¼Œå°†å·²ç» flush çš„ binlog file å’Œ position æ³¨å†Œåˆ°åŠåŒæ­¥å¤åˆ¶æ’ä»¶ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">      ç”¨äºåç»­å¯¹æ¯” slave åº”ç­”æ¥å—åˆ°çš„ binlog positionã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">RUN_HOOK</span>(binlog_storage, after_flush,</span><br><span class="line">                 (thd, file_name_ptr, flush_end_pos))) &#123;</span><br><span class="line">      <span class="built_in">LogErr</span>(ERROR_LEVEL, ER_BINLOG_FAILED_TO_RUN_AFTER_FLUSH_HOOK);</span><br><span class="line">      flush_error = ER_ERROR_ON_WRITE;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// å¦‚æœ sync_binlog!=1ï¼Œåœ¨ flush stage æ›´æ–° binlog ä½ç‚¹å¹¶å¹¿æ’­ update ä¿¡å·ï¼Œä»åº“çš„ Dump çº¿ç¨‹å¯ä»¥ç”±æ­¤æ„ŸçŸ¥ Binlog çš„æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (!update_binlog_end_pos_after_sync) <span class="built_in">update_binlog_end_pos</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Flush stage çš„ä¸»è¦å¤„ç†é€»è¾‘é›†ä¸­åœ¨ process_flush_stage_queueï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">MYSQL_BIN_LOG::process_flush_stage_queue</span><span class="params">(<span class="type">my_off_t</span> *total_bytes_var,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">bool</span> *rotate_var,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             THD **out_queue_var)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> no_flushes = <span class="number">0</span>;</span><br><span class="line">  <span class="type">my_off_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">mysql_mutex_assert_owner</span>(&amp;LOCK_log);</span><br><span class="line">  <span class="comment">// æ ¹æ® innodb_flush_log_at_trx_commit å‚æ•°è¿›è¡Œ redo log çš„åˆ·ç›˜æ“ä½œ</span></span><br><span class="line">  THD *first_seen = <span class="built_in">fetch_and_process_flush_stage_queue</span>();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// è°ƒç”¨ get_server_sidno() å’Œ Gtid_state::get_automatic_gno ç”Ÿæˆ GTID</span></span><br><span class="line">  <span class="built_in">assign_automatic_gtids_to_flush_group</span>(first_seen);</span><br><span class="line">  <span class="comment">/* Flush thread caches to binary log. */</span></span><br><span class="line">  <span class="keyword">for</span> (THD *head = first_seen; head; head = head-&gt;next_to_commit) &#123;</span><br><span class="line">    <span class="function">Thd_backup_and_restore <span class="title">switch_thd</span><span class="params">(current_thd, head)</span></span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      flush binlog_cache_mngr çš„ stmt_cacheå’Œtrx_cacheã€‚</span></span><br><span class="line"><span class="comment">      flush trx_cacheï¼š</span></span><br><span class="line"><span class="comment">        - ç”Ÿæˆ last_committed å’Œ sequence_number</span></span><br><span class="line"><span class="comment">        - flush GTID log event</span></span><br><span class="line"><span class="comment">        - å°† trx_cache ä¸­çš„æ•°æ® flush åˆ° binlog cache ä¸­</span></span><br><span class="line"><span class="comment">        - å‡†å¤‡æäº¤äº‹åŠ¡åçš„ Binlog pos</span></span><br><span class="line"><span class="comment">        - é€’å¢ prepread XID</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    std::pair&lt;<span class="type">int</span>, <span class="type">my_off_t</span>&gt; result = <span class="built_in">flush_thread_caches</span>(head);</span><br><span class="line">    total_bytes += result.second;</span><br><span class="line">    <span class="keyword">if</span> (flush_error == <span class="number">1</span>) flush_error = result.first;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">    no_flushes++;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  *out_queue_var = first_seen;</span><br><span class="line">  *total_bytes_var = total_bytes;</span><br><span class="line">  <span class="keyword">if</span> (total_bytes &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      (m_binlog_file-&gt;<span class="built_in">get_real_file_size</span>() &gt;= (<span class="type">my_off_t</span>)max_size ||</span><br><span class="line">       <span class="built_in">DBUG_EVALUATE_IF</span>(<span class="string">&quot;simulate_max_binlog_size&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>)))</span><br><span class="line">    *rotate_var = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">  <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;info&quot;</span>, (<span class="string">&quot;no_flushes:= %d&quot;</span>, no_flushes));</span><br><span class="line">  no_flushes = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> flush_error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redo log åˆ·ç›˜çš„å †æ ˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å¹¶æ¸…ç©º BINLOG_FLUSH_STAGE å’Œ COMMIT_ORDER_FLUSH_STAGE é˜Ÿåˆ—ï¼Œflush äº‹åŠ¡åˆ°ç£ç›˜ï¼›ä¸å†é˜»å¡ slave çš„ preserve commit order çš„æ‰§è¡Œ</span></span><br><span class="line">|fetch_and_process_flush_stage_queue  </span><br><span class="line"><span class="comment">// å­˜å‚¨å¼•æ“å±‚å°† prepare çŠ¶æ€çš„ redo log æ ¹æ® innodb_flush_log_at_trx_commit å‚æ•°åˆ·ç›˜</span></span><br><span class="line">|--ha_flush_logs                      </span><br><span class="line">|----innobase_flush_logs</span><br><span class="line">|------log_buffer_flush_to_disk</span><br></pre></td></tr></table></figure>

<h5 id="SYNC-é˜¶æ®µ"><a href="#SYNC-é˜¶æ®µ" class="headerlink" title="SYNC é˜¶æ®µ"></a>SYNC é˜¶æ®µ</h5><p>Sync é˜¶æ®µçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Stage #2: Syncing binary log file to disk</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">change_stage</span>(thd, Commit_stage_manager::SYNC_STAGE, wait_queue, &amp;LOCK_log,</span><br><span class="line">                 &amp;LOCK_sync)) &#123;</span><br><span class="line">  <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;return&quot;</span>, (<span class="string">&quot;Thread ID: %u, commit_error: %d&quot;</span>, thd-&gt;<span class="built_in">thread_id</span>(),</span><br><span class="line">                        thd-&gt;commit_error));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">finish_commit</span>(thd);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  - sync_counterï¼šcommit groupçš„æ•°é‡</span></span><br><span class="line"><span class="comment">  - get_sync_period()ï¼šè·å–sync_binlogå‚æ•°çš„å€¼</span></span><br><span class="line"><span class="comment">  - å¦‚æœsync stageé˜Ÿåˆ—ä¸­çš„commit groupå¤§äºç­‰äºsync_binlogçš„å€¼ï¼Œå½“å‰leaderå°±è°ƒç”¨fsync()è¿›è¡Œåˆ·ç›˜æ“ä½œï¼ˆsync_binlog_file(false)ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">    åœ¨syncä¹‹å‰å¯èƒ½ä¼šè¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…æ›´å¤šçš„commit groupå…¥é˜Ÿï¼Œç­‰å¾…çš„æ—¶é—´ä¸ºbinlog_group_commit_sync_no_delay_countæˆ–binlog_group_commit_sync_delayï¼Œé»˜è®¤éƒ½ä¸º0ã€‚</span></span><br><span class="line"><span class="comment">  - å¦‚æœsync stageé˜Ÿåˆ—ä¸­çš„commit groupå°äºsync_binlogçš„å€¼ï¼Œå½“å‰leaderä¸ä¼šè°ƒç”¨fsync()è¿›è¡Œåˆ·ç›˜ä¹Ÿä¸ä¼šç­‰å¾…</span></span><br><span class="line"><span class="comment">  - å¦‚æœsync_binlogä¸º0ï¼Œæ¯ä¸ªcommit groupéƒ½ä¼šè§¦å‘ç­‰å¾…åŠ¨ä½œï¼Œä½†æ˜¯ä¸ä¼šsync</span></span><br><span class="line"><span class="comment">  - å¦‚æœsync_binlogä¸º1ï¼Œæ¯ä¸ªcommit groupéƒ½ä¼šè§¦å‘ç­‰å¾…åŠ¨ä½œï¼Œä¸”ä¼šsync</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (!flush_error &amp;&amp; (sync_counter + <span class="number">1</span> &gt;= <span class="built_in">get_sync_period</span>()))</span><br><span class="line">  Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">wait_count_or_timeout</span>(</span><br><span class="line">      opt_binlog_group_commit_sync_no_delay_count,</span><br><span class="line">      opt_binlog_group_commit_sync_delay, Commit_stage_manager::SYNC_STAGE);</span><br><span class="line"> </span><br><span class="line">final_queue = Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">fetch_queue_acquire_lock</span>(</span><br><span class="line">    Commit_stage_manager::SYNC_STAGE);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (flush_error == <span class="number">0</span> &amp;&amp; total_bytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;before_sync_binlog_file&quot;</span>);</span><br><span class="line">  std::pair&lt;<span class="type">bool</span>, <span class="type">bool</span>&gt; result = <span class="built_in">sync_binlog_file</span>(<span class="literal">false</span>);</span><br><span class="line">  sync_error = result.first;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> å¦‚æœsync_binlog==1,åœ¨sync stageé˜¶æ®µæ›´æ–°binogä½ç‚¹ï¼Œå¹¶å¹¿æ’­updateä¿¡å·ï¼Œä»åº“çš„Dumpçº¿ç¨‹å¯ä»¥ç”±æ­¤æ„ŸçŸ¥Binlogçš„æ›´æ–°</span></span><br><span class="line"><span class="comment"> ï¼ˆä½ç‚¹åœ¨flush stageä¸­çš„process_flush_stage_queue()</span></span><br><span class="line"><span class="comment">                       |--flush_thread_caches()</span></span><br><span class="line"><span class="comment">                       |-----set_trans_pos()å‡½æ•°ä¸­è®¾ç½®ï¼‰</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (update_binlog_end_pos_after_sync &amp;&amp; flush_error == <span class="number">0</span> &amp;&amp; sync_error == <span class="number">0</span>) &#123;</span><br><span class="line">  THD *tmp_thd = final_queue;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *binlog_file = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">my_off_t</span> pos = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">while</span> (tmp_thd != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp_thd-&gt;commit_error == THD::CE_NONE) &#123;</span><br><span class="line">      tmp_thd-&gt;<span class="built_in">get_trans_fixed_pos</span>(&amp;binlog_file, &amp;pos);</span><br><span class="line">    &#125;</span><br><span class="line">    tmp_thd = tmp_thd-&gt;next_to_commit;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (binlog_file != <span class="literal">nullptr</span> &amp;&amp; pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">update_binlog_end_pos</span>(binlog_file, pos);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;bgc_after_sync_stage_before_commit_stage&quot;</span>);</span><br><span class="line"> </span><br><span class="line">leave_mutex_before_commit_stage = &amp;LOCK_sync;</span><br></pre></td></tr></table></figure>

<h5 id="COMMIT-é˜¶æ®µ"><a href="#COMMIT-é˜¶æ®µ" class="headerlink" title="COMMIT é˜¶æ®µ"></a>COMMIT é˜¶æ®µ</h5><p>Commit é˜¶æ®µçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Stage #3: Commit all transactions in order.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">commit_stage:</span><br><span class="line">  <span class="comment">/* binlog_order_commitsï¼šæ˜¯å¦è¿›è¡Œ order commitï¼Œå³ä¿æŒ redo å’Œ binlog çš„æäº¤é¡ºåºä¸€è‡´ */</span></span><br><span class="line">  <span class="keyword">if</span> ((opt_binlog_order_commits || Clone_handler::<span class="built_in">need_commit_order</span>()) &amp;&amp;</span><br><span class="line">      (sync_error == <span class="number">0</span> || binlog_error_action != ABORT_SERVER)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">change_stage</span>(thd, Commit_stage_manager::COMMIT_STAGE, final_queue,</span><br><span class="line">                     leave_mutex_before_commit_stage, &amp;LOCK_commit)) &#123;</span><br><span class="line">      <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;return&quot;</span>, (<span class="string">&quot;Thread ID: %u, commit_error: %d&quot;</span>, thd-&gt;<span class="built_in">thread_id</span>(),</span><br><span class="line">                            thd-&gt;commit_error));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">finish_commit</span>(thd);</span><br><span class="line">    &#125;</span><br><span class="line">    THD *commit_queue =</span><br><span class="line">        Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">fetch_queue_acquire_lock</span>(</span><br><span class="line">            Commit_stage_manager::COMMIT_STAGE);</span><br><span class="line">    <span class="built_in">DBUG_EXECUTE_IF</span>(<span class="string">&quot;semi_sync_3-way_deadlock&quot;</span>,</span><br><span class="line">                    <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;before_process_commit_stage_queue&quot;</span>););</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (flush_error == <span class="number">0</span> &amp;&amp; sync_error == <span class="number">0</span>)</span><br><span class="line">      <span class="comment">/* after_sync hook */</span></span><br><span class="line">      sync_error = <span class="built_in">call_after_sync_hook</span>(commit_queue);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Commit é˜¶æ®µçš„ä¸»è¦å¤„ç†é€»è¾‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">process_commit_stage_queue</span>(thd, commit_queue);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * After commit stage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">change_stage</span>(thd, Commit_stage_manager::AFTER_COMMIT_STAGE,</span><br><span class="line">                     commit_queue, &amp;LOCK_commit, &amp;LOCK_after_commit)) &#123;</span><br><span class="line">      <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;return&quot;</span>, (<span class="string">&quot;Thread ID: %u, commit_error: %d&quot;</span>, thd-&gt;<span class="built_in">thread_id</span>(),</span><br><span class="line">                            thd-&gt;commit_error));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">finish_commit</span>(thd);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    THD *after_commit_queue =</span><br><span class="line">        Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">fetch_queue_acquire_lock</span>(</span><br><span class="line">            Commit_stage_manager::AFTER_COMMIT_STAGE);</span><br><span class="line">    <span class="comment">/* after_commit hook */</span></span><br><span class="line">    <span class="built_in">process_after_commit_stage_queue</span>(thd, after_commit_queue);</span><br><span class="line"> </span><br><span class="line">    final_queue = after_commit_queue;</span><br><span class="line">    <span class="built_in">mysql_mutex_unlock</span>(&amp;LOCK_after_commit);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (leave_mutex_before_commit_stage)</span><br><span class="line">      <span class="built_in">mysql_mutex_unlock</span>(leave_mutex_before_commit_stage);</span><br><span class="line">    <span class="keyword">if</span> (flush_error == <span class="number">0</span> &amp;&amp; sync_error == <span class="number">0</span>)</span><br><span class="line">      sync_error = <span class="built_in">call_after_sync_hook</span>(final_queue);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* å¹¿æ’­ m_stage_cond_binlog ä¿¡å·å˜é‡ï¼Œå”¤é†’æŒ‚èµ·çš„ follower */</span></span><br><span class="line">  Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">signal_done</span>(final_queue);</span><br><span class="line">  <span class="built_in">DBUG_EXECUTE_IF</span>(<span class="string">&quot;block_leader_after_delete&quot;</span>, &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> action[] = <span class="string">&quot;now SIGNAL leader_proceed&quot;</span>;</span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">debug_sync_set_action</span>(thd, <span class="built_in">STRING_WITH_LEN</span>(action)));</span><br><span class="line">  &#125;;);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Finish the commit before executing a rotate, or run the risk of a</span></span><br><span class="line"><span class="comment">    deadlock. We don&#x27;t need the return value here since it is in</span></span><br><span class="line"><span class="comment">    thd-&gt;commit_error, which is returned below.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  (<span class="type">void</span>)<span class="built_in">finish_commit</span>(thd);</span><br><span class="line">  <span class="built_in">DEBUG_SYNC</span>(thd, <span class="string">&quot;bgc_after_commit_stage_before_rotation&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> thd-&gt;commit_error == THD::CE_COMMIT_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Commit é˜¶æ®µçš„ä¸»è¦å¤„ç†é€»è¾‘é›†ä¸­åœ¨ process_commit_stage_queue å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MYSQL_BIN_LOG::process_commit_stage_queue</span><span class="params">(THD *thd, THD *first)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">mysql_mutex_assert_owner</span>(&amp;LOCK_commit);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">  thd-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.ready_preempt =</span><br><span class="line">      <span class="literal">true</span>;  <span class="comment">// formality by the leader</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (THD *head = first; head; head = head-&gt;next_to_commit) &#123;</span><br><span class="line">    <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;debug&quot;</span>, (<span class="string">&quot;Thread ID: %u, commit_error: %d, commit_pending: %s&quot;</span>,</span><br><span class="line">                         head-&gt;<span class="built_in">thread_id</span>(), head-&gt;commit_error,</span><br><span class="line">                         <span class="built_in">YESNO</span>(head-&gt;tx_commit_pending)));</span><br><span class="line">    <span class="built_in">DBUG_EXECUTE_IF</span>(</span><br><span class="line">        <span class="string">&quot;block_leader_after_delete&quot;</span>,</span><br><span class="line">        <span class="keyword">if</span> (thd != head) &#123; <span class="built_in">DBUG_SET</span>(<span class="string">&quot;+d,after_delete_wait&quot;</span>); &#125;;);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If flushing failed, set commit_error for the session, skip the</span></span><br><span class="line"><span class="comment">      transaction and proceed with the next transaction instead. This</span></span><br><span class="line"><span class="comment">      will mark all threads as failed, since the flush failed.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">      If flush succeeded, attach to the session and commit it in the</span></span><br><span class="line"><span class="comment">      engines.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line">    Commit_stage_manager::<span class="built_in">get_instance</span>().<span class="built_in">clear_preempt_status</span>(head);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      æ›´æ–°å…¨å±€çš„ m_max_committed_transactionï¼ˆç”¨ä½œåç»­äº‹åŠ¡çš„ last_committedï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">      å¹¶åˆå§‹æœ¬äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ sequence number</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (head-&gt;<span class="built_in">get_transaction</span>()-&gt;sequence_number != SEQ_UNINIT) &#123;</span><br><span class="line">      <span class="built_in">mysql_mutex_lock</span>(&amp;LOCK_replica_trans_dep_tracker);</span><br><span class="line">      m_dependency_tracker.<span class="built_in">update_max_committed</span>(head);</span><br><span class="line">      <span class="built_in">mysql_mutex_unlock</span>(&amp;LOCK_replica_trans_dep_tracker);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Flush/Sync error should be ignored and continue</span></span><br><span class="line"><span class="comment">      to commit phase. And thd-&gt;commit_error cannot be</span></span><br><span class="line"><span class="comment">      COMMIT_ERROR at this moment.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">assert</span>(head-&gt;commit_error != THD::CE_COMMIT_ERROR);</span><br><span class="line">    <span class="function">Thd_backup_and_restore <span class="title">switch_thd</span><span class="params">(thd, head)</span></span>;</span><br><span class="line">    <span class="type">bool</span> all = head-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.real_commit;</span><br><span class="line">    <span class="built_in">assert</span>(!head-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.commit_low ||</span><br><span class="line">           head-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.ready_preempt);&lt;br&gt;  <span class="comment">// Binlog Commitã€Innodb Commit</span></span><br><span class="line">    ::<span class="built_in">finish_transaction_in_engines</span>(head, all, <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">DBUG_PRINT</span>(<span class="string">&quot;debug&quot;</span>, (<span class="string">&quot;commit_error: %d, commit_pending: %s&quot;</span>,</span><br><span class="line">                         head-&gt;commit_error, <span class="built_in">YESNO</span>(head-&gt;tx_commit_pending)));</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    é”å®š sidnoï¼Œæ›´æ–°æ•´ç»„äº‹åŠ¡ çš„executed_gtid</span></span><br><span class="line"><span class="comment">    - å¦‚æœæ²¡å¼€å¯ binlogï¼Œ@@GLOBAL.GTID_PURGED çš„å€¼æ˜¯ä» executed_gtid è·å–çš„ï¼Œ</span></span><br><span class="line"><span class="comment">      æ­¤æ—¶ @@GLOBAL.GTID_PURGED çš„å€¼å’Œ @@GLOBAL.GTID_EXECUTED æ°¸è¿œæ˜¯ä¸€è‡´çš„ï¼Œ</span></span><br><span class="line"><span class="comment">      å°±ä¸éœ€è¦åœ¨è®°å½• lost_gtids</span></span><br><span class="line"><span class="comment">    - å¦‚æœå¼€å¯äº† binlogï¼Œä½†æ˜¯æœªå¼€å¯ log_replica_updatesï¼Œslave çš„ SQL çº¿ç¨‹æˆ– slave worker çº¿ç¨‹</span></span><br><span class="line"><span class="comment">      å°†è‡ªèº«çš„ GTID æ›´æ–°åˆ° executed_gtidsã€lost_gtids</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  gtid_state-&gt;<span class="built_in">update_commit_group</span>(first);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (THD *head = first; head; head = head-&gt;next_to_commit) &#123;</span><br><span class="line">    <span class="function">Thd_backup_and_restore <span class="title">switch_thd</span><span class="params">(thd, head)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> all = head-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.real_commit;</span><br><span class="line">    <span class="comment">// åªé’ˆå¯¹å¤–éƒ¨ XA äº‹åŠ¡ï¼Œåœ¨å­˜å‚¨å¼•æ“å±‚å°†äº‹åŠ¡æ ‡è®°ä¸º Prepared</span></span><br><span class="line">    trx_coordinator::<span class="built_in">set_prepared_in_tc_in_engines</span>(head, all);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      åœ¨å­˜å‚¨å¼•æ“å±‚æäº¤ä¹‹åï¼Œé€’å‡ Prepared çŠ¶æ€ä¸‹çš„ XID è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (head-&gt;<span class="built_in">get_transaction</span>()-&gt;m_flags.xid_written) <span class="built_in">dec_prep_xids</span>(head);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ ::finish_transaction_in_engines  å‡½æ•°æ˜¯ä¸»è¦çš„å­˜å‚¨å¼•æ“å±‚æäº¤é€»è¾‘ï¼Œç›¸å…³å †æ ˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">|::finish_transaction_in_engines</span><br><span class="line">|--trx_coordinator::commit_in_engines</span><br><span class="line">|----ha_commit_low</span><br><span class="line">// Binlog å±‚æäº¤ä»€ä¹ˆä¹Ÿä¸åšï¼ˆç©ºå‡½æ•°ï¼‰</span><br><span class="line">|------binlog_commit</span><br><span class="line">// å­˜å‚¨å¼•æ“å±‚æäº¤</span><br><span class="line">|------innobase_commit                                </span><br><span class="line">|--------innobase_commit_low</span><br><span class="line">|----------trx_commit_for_mysql</span><br><span class="line">// ä¸ºæŒä¹…åŒ– GTID æå‰åˆ†é… update undo segment</span><br><span class="line">|------------trx_undo_gtid_add_update_undo  </span><br><span class="line">// æ›´æ–°æ•°æ®å­—å…¸ä¸­è¢«ä¿®æ”¹è¡¨çš„ update_time æ—¶é—´</span><br><span class="line">|------------trx_update_mod_tables_timestamp     </span><br><span class="line">// åˆ†é… Mini-transaction handle å’Œ buffer</span><br><span class="line">|------------trx_commit          </span><br><span class="line">// æäº¤ mini-transaction</span><br><span class="line">|--------------trx_commit_low                         </span><br><span class="line">|----------------trx_write_serialisation_history</span><br><span class="line">// æ›´æ–° undo çŠ¶æ€ï¼š</span><br><span class="line">// å¯¹äº insert çŠ¶æ€ä» TRX_UNDO_ACTIVE ä¿®æ”¹ä¸º TRX_UNDO_TO_FREE</span><br><span class="line">// update ä¿®æ”¹ä¸º TRX_UNDO_TO_PURGE</span><br><span class="line">// å¦‚æœäº‹åŠ¡ä¸º update è¿˜éœ€è¦å°† rollback segments åˆ†é… trx noï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° purge é˜Ÿåˆ—ä¸­</span><br><span class="line">|------------------trx_undo_set_state_at_finish      </span><br><span class="line">//å°† update undo log header æ·»åŠ åˆ° history list å¼€å¤´é‡Šæ”¾ä¸€äº›å†…å­˜å¯¹è±¡;</span><br><span class="line">|------------------trx_undo_update_cleanup  </span><br><span class="line"> // åœ¨ç³»ç»Ÿäº‹åŠ¡è¡¨è®°å½• binlog ä½ç‚¹</span><br><span class="line">|------------------trx_sys_update_mysql_binlog_offset </span><br><span class="line">|----------------trx_commit_in_memory</span><br><span class="line">//- å…³é—­ mvcc read view</span><br><span class="line">//- æŒä¹…åŒ– GTID</span><br><span class="line">//- é‡Šæ”¾ insert undo log</span><br><span class="line">//- å”¤é†’åå°çº¿ç¨‹å¼€å§‹å¹²æ´»ï¼Œå¦‚ï¼šmaster threadã€purge threadã€page_cleaner</span><br></pre></td></tr></table></figure>


<h4 id="5-3-3-3ã€commité˜¶æ®µå°ç»“"><a href="#5-3-3-3ã€commité˜¶æ®µå°ç»“" class="headerlink" title="5.3.3.3ã€commité˜¶æ®µå°ç»“"></a>5.3.3.3ã€commité˜¶æ®µå°ç»“</h4><p>äºŒé˜¶æ®µæäº¤çš„ commit é˜¶æ®µåˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼šflush å­é˜¶æ®µã€sync å­é˜¶æ®µã€commit å­é˜¶æ®µã€‚</p>
<p>flush å­é˜¶æ®µä¼šæŠŠ prepare é˜¶æ®µåŠä¹‹å‰äº§ç”Ÿçš„ redo æ—¥å¿—éƒ½åˆ·ç›˜ï¼ŒæŠŠäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ binlog æ—¥å¿—å†™å…¥ binlog æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>sync å­é˜¶æ®µä¼šæ ¹æ®ç³»ç»Ÿå˜é‡ sync_binlog çš„å€¼å†³å®šæ˜¯å¦æŠŠ binlog æ—¥å¿—åˆ·ç›˜ã€‚</p>
<p>ä¸ºäº†é¿å…æ¯ä¸ªäº‹åŠ¡å„è‡ªæäº¤ï¼Œè§¦å‘æ“ä½œç³»ç»Ÿå¯¹åŒä¸€ä¸ªé¡µé¢‘ç¹çš„é‡å¤åˆ·ç›˜ï¼ŒInnoDB å¼•å…¥äº†ç»„æäº¤ã€‚</p>
<p>ä¸ºäº†é¿å…æ¯ä¸ªå­é˜¶æ®µå‡ºç°å¤šä¸ªé˜Ÿé•¿åŒæ—¶å¹²æ´»çš„æƒ…å†µï¼ŒInnoDB è¿˜å¼•å…¥äº†ä¸‰ä¸ªäº’æ–¥é‡ï¼šLOCK_logã€LOCK_syncã€LOCK_commitã€‚</p>
<h3 id="5-3-4ã€mtr-t-commit"><a href="#5-3-4ã€mtr-t-commit" class="headerlink" title="5.3.4ã€mtr_t::commit()"></a>5.3.4ã€mtr_t::commit()</h3><p>InnoDBä¼šå°†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹æ‹†åˆ†ä¸ºè‹¥å¹²ä¸ªMini Transactionï¼ˆmtrï¼‰ï¼Œæ¯ä¸ªmtråŒ…å«ä¸€ç³»åˆ—å¦‚åŠ é”ï¼Œå†™æ•°æ®ï¼Œå†™redoï¼Œæ”¾é”ç­‰æ“ä½œã€‚</p>
<p>åœ¨â€œæ‰§è¡Œinsertè¯­å¥â€ç« èŠ‚ å’Œ â€œcommité˜¶æ®µâ€ä¸­éƒ½æœ‰æåˆ°è¿™ä¸ªå†…å®¹ã€‚</p>
<h4 id="5-3-4-1ã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ"><a href="#5-3-4-1ã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ" class="headerlink" title="5.3.4.1ã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ"></a>5.3.4.1ã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h4><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªmtrå¤§è‡´çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿™é‡Œä»…éœ€è¦çŸ¥é“mtr.commit()æ˜¯å¼€å§‹å†™redo logçš„åœ°æ–¹å°±å¯ä»¥äº†ã€‚</p>
<ul>
<li>mtr.start() å¼€å¯ä¸€ä¸ªmini transaction</li>
<li>mtr_x_lock() <font color="green"><strong>åŠ é”</strong></font>ï¼Œè¿™ä¸ªæ“ä½œåˆ†æˆä¸¤æ­¥ï¼Œ1. å¯¹space-&gt;latchåŠ Xé”ï¼›2. å°†space-&gt;latchæ”¾å…¥mtr_t::m_impl::memoä¸­ï¼ˆè¿™æ ·åœ¨mtr.commit()åå°±å¯ä»¥å°†mträ¹‹å‰åŠ è¿‡çš„é”æ”¾æ‰ï¼‰</li>
<li>mlog_write_ull <font color="green"><strong>å†™æ•°æ®</strong></font>ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿåˆ†æˆä¸¤æ­¥ï¼Œ1. ç›´æ¥ä¿®æ”¹pageä¸Šçš„æ•°æ®ï¼›2. å°†è¯¥æ“ä½œçš„redo logå†™å…¥mtr::m_impl::m_logä¸­</li>
<li>mtr.commit() <font color="green"><strong>å†™redo log + æ”¾é”</strong></font>ï¼Œè¿™ä¸ªæ“ä½œä¼šå°†ä¸Šä¸€æ­¥m_logä¸­çš„å†…å®¹å†™å…¥redo log fileï¼Œå¹¶ä¸”åœ¨æœ€åæ”¾é”</li>
</ul>
<h4 id="5-3-4-2ã€åŸºæœ¬åŸç†"><a href="#5-3-4-2ã€åŸºæœ¬åŸç†" class="headerlink" title="5.3.4.2ã€åŸºæœ¬åŸç†"></a>5.3.4.2ã€åŸºæœ¬åŸç†</h4><p>MTR åŸºäº WALï¼ˆWrite - Ahead Loggingï¼‰é¢„å†™å¼æ—¥å¿—çš„åŸç†ã€‚åœ¨å¯¹æ•°æ®é¡µè¿›è¡Œä¿®æ”¹ä¹‹å‰ï¼Œå…ˆå°†ä¿®æ”¹æ“ä½œè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚è¿™æ ·ï¼Œå³ä½¿åœ¨ä¿®æ”¹æ•°æ®é¡µçš„è¿‡ç¨‹ä¸­å‡ºç°ç³»ç»Ÿå´©æºƒï¼Œä¹Ÿå¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œæ—¥å¿—ä¸­çš„æ“ä½œæ¥æ¢å¤æ•°æ®ã€‚</p>
<blockquote>
<p>mini-transactionæ˜¯mysqlå†…éƒ¨çš„å¯¹åº•å±‚pageçš„ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¿è¯å¹¶å‘äº‹åŠ¡æ“ä½œä¸‹ä»¥åŠæ•°æ®åº“å¼‚å¸¸æ—¶pageä¸­æ•°æ®çš„ä¸€è‡´æ€§ã€‚<br>ä¸€èˆ¬æ¥è¯´åœ¨ä¸€ä¸ªMTRä¸­ä¼šåšä¸¤ä¸ªäº‹æƒ….</p>
<ul>
<li>å†™redolog</li>
<li>æŒ‚è½½è„é¡µåˆ°flush list.</li>
</ul>
<p>mini transaction çš„ä¿¡æ¯ä¿å­˜åœ¨ç»“æ„ä½“ mtr_t ä¸­ï¼Œç»“æ„ä½“æˆå‘˜æè¿°è¯¦è§å‰æ–‡ï¼Œå…¶ä¸­m_memoå’Œm_logæœ€ä¸ºé‡è¦ã€‚</p>
<ul>
<li>m_memoï¼šç®¡ç†mtræŒæœ‰çš„é”ä¿¡æ¯ã€‚å¯¹äºæŒæœ‰çš„pageé”ï¼Œè¿˜è¦ä¿ç•™pageæŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºäº†åœ¨commitæ—¶ï¼Œå°†ä¿®æ”¹çš„è„é¡µåŠ å…¥flush listä¸­ã€‚</li>
<li>m_logï¼šä¿å­˜mträ¿®æ”¹æ“ä½œå¯¹åº”çš„redoæ—¥å¿—ã€‚åœ¨commitæ—¶ï¼Œå°†redoæ—¥å¿—ä¸€èµ·æ‹·è´åˆ°log_sysæ¨¡å—çš„å…¬å…±æ—¥å¿—bufferä¸­ã€‚</li>
</ul>
<p>mini-transactionå’Œæˆ‘ä»¬ç†è§£çš„æ•°æ®åº“äº‹åŠ¡ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚ä»ä¸€è‡´æ€§æ¥è®²ï¼Œæ•°æ®åº“äº‹åŠ¡æ˜¯ä¿è¯å¤šæ¡è¯­å¥æ“ä½œçš„ä¸€è‡´æ€§ï¼Œå¾€å¾€æ¶‰åŠåˆ°å¤šä¸ªé¡µçš„ä¿®æ”¹ã€‚è€Œmini-transactionæ˜¯å•é¡µæ•°æ®ä¸€è‡´æ€§ï¼Œæ˜¯é¿å…å†…å­˜é¡µçš„å¹¶å‘æ›´æ–°å½±å“ã€‚å½“ç„¶æ•°æ®åº“äº‹åŠ¡ä¸€è‡´æ€§å®ç°ä¹Ÿæ˜¯å»ºç«‹åœ¨mini-transactionçš„åŸºç¡€ä¸Šçš„ã€‚<br>æ‰€æœ‰å¯¹é¡µçš„æ“ä½œéƒ½è¦åœ¨mini_transactionä¸­æ‰§è¡Œã€‚</p>
</blockquote>
<h4 id="5-3-4-3ã€æ‰§è¡Œæµç¨‹"><a href="#5-3-4-3ã€æ‰§è¡Œæµç¨‹" class="headerlink" title="5.3.4.3ã€æ‰§è¡Œæµç¨‹"></a>5.3.4.3ã€æ‰§è¡Œæµç¨‹</h4><p><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/mtr_commit.png" alt="mtr_commit"><br>mtr_t::commit()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mtr.commit() â‘¢</span><br><span class="line">mtr_t::Command::execute()</span><br><span class="line">  |--&gt; struct mtr_write_log_t&#123;operator()&#125; // è¿™é‡Œä½¿ç”¨operator()é‡è½½è¿ç®—ç¬¦ï¼Œé€šè¿‡è¿­ä»£å‡½æ•°éå†blocks</span><br><span class="line">  |  |--&gt; log_buffer_write // æŠŠredoå•ä¸ªblockå†™å…¥ redo log buffer. [è§ä¸‹æ–‡]</span><br><span class="line">  |  |--&gt; log_buffer_write_completed // log bufferå·²å®Œæˆ [è§ä¸‹æ–‡]</span><br><span class="line">  |--&gt; log_buffer_reserve // è¿™é‡Œæ¶‰åŠåˆ° ç”¨æˆ·çº¿ç¨‹å’Œwrite flushçº¿ç¨‹çš„å¹¿æ’­å…³ç³»ã€‚[è§ä¸‹æ–‡]</span><br><span class="line">  |--&gt; add_dirty_blocks_to_flush_list // mträ¸­ä¿®æ”¹çš„blocksåŠ åˆ° buffer_pool çš„flush_list; è¿­ä»£å‡½æ•°</span><br><span class="line">  |--&gt; log_buffer_close // å¯¹åº” log_buffer_reserveï¼Œlog buffer ç»“æŸ [è§ä¸‹æ–‡]</span><br><span class="line">  |--&gt; release_all -&gt; memo_slot_release // é‡Šæ”¾mtrçš„æ‰€æœ‰latchå’Œlock; è¿­ä»£å‡½æ•° [è§ä¸‹å›¾latchå’Œlockçš„æšä¸¾]</span><br><span class="line">  |  |--&gt; buf_page_release_latch/rw_lock_s_unlock/.. </span><br><span class="line">  |--&gt; release_resources // æ¸…ç†ä¸€äº›å¯¹è±¡ä¿¡æ¯</span><br></pre></td></tr></table></figure>
<p>**log_buffer_write()**ï¼š æ¯ä¸ªredo blockå†™å…¥redo log bufferã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_buffer_write (log_t &amp;log, const byte *str,..) //ä¹‹å‰è¿˜æœ‰å¾ˆå¤šé€»è¾‘ï¼Œå…¬å…±bufferä»¥512å­—èŠ‚å¯¹é½</span><br><span class="line">  |--&gt; byte *ptr = log.buf + (start_lsn % log.buf_size); //æœ€åæ—¥å¿—ä»mtræ‹·è´åˆ°RedoLog Buffer(å…¬å…±buffer)</span><br><span class="line">  |--&gt; std::memcpy(ptr, str, len);</span><br></pre></td></tr></table></figure>
<p><strong>log_buffer_reserve()</strong> ï¼šè¿™é‡Œè°ƒç”¨ log_write_up_to æŠŠwriteå’Œflushçš„ä»»åŠ¡å¼‚æ­¥ä¸‹å‘ç»™ log_writer å’Œ log_flusherå»å®Œæˆï¼ŒåŒæ—¶ åˆå§‹åŒ–åˆ¤æ–­ writer å’Œ flushæ˜¯å¦æ­£ç¡®å®Œæˆçš„æ¡ä»¶conditionå‡½æ•°ï¼Œå¼€å¯å¼‚æ­¥ç­‰å¾…events[]ï¼Œå¾… log writer å’Œ log flusherå®Œæˆåï¼Œå†å”¤é†’ ç”¨æˆ·çº¿ç¨‹ï¼Œç»§ç»­åé¢çš„å·¥ä½œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_buffer_reserve</span><br><span class="line">  |--&gt; log_buffer_s_lock_enter_reserve -&gt; log.sn.fetch_add(len) //æ›´æ–°snå¢é‡redoé•¿åº¦</span><br><span class="line">  |--&gt; if (end_sn &gt; log.buf_limit_sn.load()) log bufferç©ºé—´ä¸è¶³ </span><br><span class="line">  |  |--&gt; log_wait_for_space_after_reserving -&gt; log_wait_for_space_in_log_buf</span><br><span class="line">  |  |  |--&gt; log_write_up_to //ç”¨æˆ·çº¿ç¨‹è§¦å‘ write/flushçº¿ç¨‹ï¼Œä»¥åŠå¼‚æ­¥ç­‰å¾…è¿”å›ç»“æœã€‚</span><br><span class="line">  |  |  |  |--&gt; log_wait_for_write </span><br><span class="line">  |  |  |  |--&gt; log_wait_for_flush </span><br></pre></td></tr></table></figure>
<p>**log_buffer_write_completed()**ï¼šä¸»è¦ä½œç”¨æ˜¯æŠŠ è¦å†™çš„redo æ·»åŠ åˆ° link buf ï¼Œå¹¶æ›´æ–°link bufï¼Œæ›´æ–°m_tailã€write_lsnã€current_lsnï¼Œåé¢åœ¨ ã€æ— é”å¹¶å‘å†™å…¥ã€‘ä¼šè¿›ä¸€æ­¥è¯´æ˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_buffer_write_completed</span><br><span class="line">  |--&gt; !while(log.recent_written.has_space()) </span><br><span class="line">  |  |--&gt; os_event_set(log.writer_event) // Redoæ²¡ç©ºé—´äº†ï¼Œç«‹å³write page cache æ¥é‡Šæ”¾ã€‚</span><br><span class="line">  |--&gt; log.recent_written.add_link_advance_tail() // æ›´æ–°å†™redoå¯¹åº”çš„ link buf [è§ä¸‹å›¾]</span><br><span class="line">  |--&gt; os_event_set(log.closer_event) // å¦‚æœæœ‰çº¿ç¨‹åœ¨ç­‰å¾… flush_list ä¸Šçš„æ•°æ®åˆ·è„ï¼Œå¹¿æ’­closer_event </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>log_buffer_close()</strong>: è¿™ä¸ªå‡½æ•°ï¼Œé€»è¾‘èµ°åˆ°è¿™é‡Œï¼Œç”¨æˆ·çº¿ç¨‹ å¯ä»¥è®¤ä¸º writeå’Œflush ä»»åŠ¡éƒ½å·²ç»ä¸‹å‘ï¼Œ å¯ä»¥å»æ›´æ–° è„é¡µæ•°æ® åœ¨ flush list ä¸Šçš„æƒ…å†µï¼Œä¸ºåˆ·è„ check point åšå‡†å¤‡ã€‚åŒredo å¹¶å‘å†™ page cacheï¼Œå¯èƒ½å­˜åœ¨ç©ºæ´ï¼Œå¤§lsnè„é¡µå·²ç»æŒ‚åˆ° flush listäº†ï¼Œå°lsnçš„è„é¡µè¿˜æ²¡æœ‰çš„æƒ…å†µã€‚recent_closed.m_tailè¡¨ç¤ºä¹‹å‰çš„lsnå·²ç»æŒ‚è½½åˆ°flush listã€‚log_closer çº¿ç¨‹è´Ÿè´£ä¸åœæ£€æŸ¥ï¼Œæ¨è¿› m_tailã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_buffer_close</span><br><span class="line">  |--&gt; log_buffer_s_lock_exit_close</span><br><span class="line">  |  |--&gt; log.recent_closed.add_link_advance_tail() </span><br></pre></td></tr></table></figure>

<p>mtr_commitæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">/** Commit a mini-transaction. */</span>*</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mtr_t::commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ut_ad</span>(<span class="built_in">is_active</span>());</span><br><span class="line">  <span class="built_in">ut_ad</span>(!<span class="built_in">is_inside_ibuf</span>());</span><br><span class="line">  <span class="built_in">ut_ad</span>(m_impl.m_magic_n == MTR_MAGIC_N);</span><br><span class="line">  m_impl.m_state = MTR_STATE_COMMITTING;</span><br><span class="line"></span><br><span class="line">  <span class="function">Command <span class="title">cmd</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (m_impl.m_n_log_recs &gt; <span class="number">0</span> ||</span><br><span class="line">      (m_impl.m_modifications &amp;&amp; m_impl.m_log_mode == MTR_LOG_NO_REDO)) &#123;</span><br><span class="line">    <span class="built_in">ut_ad</span>(!srv_read_only_mode || m_impl.m_log_mode == MTR_LOG_NO_REDO);</span><br><span class="line"></span><br><span class="line">    cmd.<span class="built_in">execute</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cmd.<span class="built_in">release_all</span>();</span><br><span class="line">    cmd.<span class="built_in">release_resources</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Command::execute<br>å› æ­¤æˆ‘ä»¬æ¥çœ‹æœ€ç»ˆçš„æ‰§è¡Œæ–¹æ³• execute</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="type">mtr_t</span>::Command::<span class="built_in">execute</span>() &#123;</span><br><span class="line">  <span class="built_in">ut_ad</span>(m_impl-&gt;m_log_mode != MTR_LOG_NONE);</span><br><span class="line"></span><br><span class="line">  ulint len;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UNIV_HOTBACKUP</span></span><br><span class="line">  len = <span class="built_in">prepare_write</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">mtr_write_log_t</span> write_log;</span><br><span class="line"></span><br><span class="line">    write_log.m_left_to_write = len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> handle = <span class="built_in">log_buffer_reserve</span>(*log_sys, len);</span><br><span class="line"></span><br><span class="line">    write_log.m_handle = handle;</span><br><span class="line">    write_log.m_lsn = handle.start_lsn;</span><br><span class="line">    write_log.m_rec_group_start_lsn = handle.start_lsn;</span><br><span class="line"></span><br><span class="line">    m_impl-&gt;m_log.for_each_block(write_log);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ut_ad</span>(write_log.m_left_to_write == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">ut_ad</span>(write_log.m_lsn == handle.end_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log_wait_for_space_in_log_recent_closed</span>(*log_sys, handle.start_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUG_SYNC_C</span>(<span class="string">&quot;mtr_redo_before_add_dirty_blocks&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add_dirty_blocks_to_flush_list</span>(handle.start_lsn, handle.end_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log_buffer_close</span>(*log_sys, handle);</span><br><span class="line"></span><br><span class="line">    m_impl-&gt;m_mtr-&gt;m_commit_lsn = handle.end_lsn;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DEBUG_SYNC_C</span>(<span class="string">&quot;mtr_noredo_before_add_dirty_blocks&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">add_dirty_blocks_to_flush_list</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> *<span class="comment">/* !UNIV_HOTBACKUP */</span>*</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">release_all</span>();</span><br><span class="line">  <span class="built_in">release_resources</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-4-4ã€å°ç»“"><a href="#5-3-4-4ã€å°ç»“" class="headerlink" title="5.3.4.4ã€å°ç»“"></a>5.3.4.4ã€å°ç»“</h4><p>ä»ä¸Šæ–‡çš„è§£æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤šæ¬¡è°ƒç”¨<code>mtr.commit()</code>ï¼Œé‚£å¤šæ¬¡è°ƒç”¨æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p><font color="green"><strong>mtr.commit()æºç ä¸­åœ¨æ’å…¥ç´¢å¼•æ•°æ®æ—¶å’Œäº‹åŠ¡äºŒé˜¶æ®µçš„prepareæ—¶éƒ½ä¼šè°ƒç”¨ï¼Œéƒ½ä¼šå†™å…¥redo log ? ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></font></p>
<h5 id="1-ç›¸åŒç‚¹ï¼šå†™å…¥-redo-log"><a href="#1-ç›¸åŒç‚¹ï¼šå†™å…¥-redo-log" class="headerlink" title="1. ç›¸åŒç‚¹ï¼šå†™å…¥ redo log"></a>1. ç›¸åŒç‚¹ï¼šå†™å…¥ redo log</h5><p>æ— è®ºæ˜¯æ’å…¥ç´¢å¼•æ•°æ®æ—¶è°ƒç”¨ mtr.commit()ï¼Œè¿˜æ˜¯åœ¨äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µè°ƒç”¨ï¼Œéƒ½ä¼šå°†ç›¸å…³æ“ä½œäº§ç”Ÿçš„ä¿®æ”¹ä¿¡æ¯å†™å…¥ redo logã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ“ä½œçš„åŸå­æ€§ã€æŒä¹…æ€§å’Œæ•°æ®ä¸€è‡´æ€§ã€‚å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œå¯ä»¥åˆ©ç”¨ redo log æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚</p>
<h5 id="2-ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«"><a href="#2-ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«" class="headerlink" title="2. ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«"></a>2. ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«</h5><ol>
<li>è°ƒç”¨æ—¶æœº<br>æ’å…¥ç´¢å¼•æ•°æ®æ—¶ï¼šæ’å…¥ç´¢å¼•æ•°æ®æ—¶è°ƒç”¨ mtr.commit() æ˜¯åœ¨å¯¹ç´¢å¼•é¡µå®Œæˆä¸€ç»„ç›¸å…³ä¿®æ”¹æ“ä½œä¹‹åã€‚ä¾‹å¦‚ï¼Œåœ¨æ’å…¥æ–°çš„ç´¢å¼•é¡¹ã€è°ƒæ•´ç´¢å¼•ç»“æ„ï¼ˆå¦‚ç´¢å¼•é¡µåˆ†è£‚ï¼‰ç­‰æ“ä½œå®Œæˆåï¼Œå°±ä¼šè°ƒç”¨ mtr.commit() æ¥ç»“æŸè¿™ä¸ªè¿·ä½ äº‹åŠ¡ï¼ˆMTRï¼‰ï¼Œå°†ä¿®æ”¹è®°å½•åˆ° redo logã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸ªä¸­é—´æ­¥éª¤ï¼Œå¯èƒ½ä¼šå¤šæ¬¡å‘ç”Ÿï¼Œå…·ä½“å–å†³äºæ’å…¥æ“ä½œçš„å¤æ‚æ€§å’Œæ¶‰åŠçš„ç´¢å¼•é¡µæ•°é‡ã€‚<br>äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µï¼šåœ¨äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µè°ƒç”¨ mtr.commit() æ˜¯åœ¨äº‹åŠ¡å·²ç»å®Œæˆäº†å¯¹æ•°æ®ï¼ˆåŒ…æ‹¬ç´¢å¼•å’Œæ•°æ®è®°å½•ï¼‰çš„æ‰€æœ‰ä¿®æ”¹æ“ä½œä¹‹åï¼Œå¹¶ä¸”åœ¨å‡†å¤‡å‘äº‹åŠ¡åè°ƒå™¨è¡¨æ˜è‡ªèº«å‡†å¤‡å¥½æäº¤äº‹åŠ¡ä¹‹å‰ã€‚è¿™æ˜¯äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå…³é”®èŠ‚ç‚¹ï¼Œç”¨äºç¡®ä¿äº‹åŠ¡çš„ä¿®æ”¹å·²ç»è¢«å®‰å…¨è®°å½•ã€‚</li>
<li>å†™å…¥å†…å®¹<br>æ’å…¥ç´¢å¼•æ•°æ®æ—¶ï¼šä¸»è¦è®°å½•çš„æ˜¯æ’å…¥ç´¢å¼•æ•°æ®è¿‡ç¨‹ä¸­å¯¹ç´¢å¼•é¡µçš„ä¿®æ”¹ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œæ–°ç´¢å¼•é¡¹çš„æ’å…¥ä½ç½®ã€ç´¢å¼•é¡µçš„æŒ‡é’ˆè°ƒæ•´ã€é”®å€¼çš„æ›´æ–°ç­‰ã€‚è¿™äº›ä¿¡æ¯ä»…ä¸ç´¢å¼•ç»“æ„çš„å˜åŒ–ç›¸å…³ï¼Œç”¨äºåœ¨ç³»ç»Ÿå´©æºƒæ—¶æ¢å¤ç´¢å¼•æ•°æ®çš„ä¸€è‡´æ€§ã€‚<br>äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µï¼šå†™å…¥çš„å†…å®¹æ›´åŠ å…¨é¢ï¼Œé™¤äº†åŒ…å«äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹ç´¢å¼•é¡µçš„ä¿®æ”¹ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…æ‹¬å¯¹æ•°æ®è®°å½•é¡µçš„ä¿®æ”¹ä¿¡æ¯ï¼Œå¦‚æ•°æ®çš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚æ­¤å¤–ï¼Œè¿˜ä¼šè®°å½•äº‹åŠ¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå°†äº‹åŠ¡æ ‡è®°ä¸º â€œå‡†å¤‡æäº¤ï¼ˆPreparedï¼‰â€ çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨åç»­çš„æäº¤æˆ–å›æ»šæ“ä½œä¸­ä½¿ç”¨ã€‚</li>
<li>æ“ä½œç›®çš„<br>æ’å…¥ç´¢å¼•æ•°æ®æ—¶ï¼šç›®çš„æ˜¯ä¿è¯æ’å…¥ç´¢å¼•æ•°æ®æ“ä½œçš„åŸå­æ€§å’ŒæŒä¹…æ€§ã€‚é€šè¿‡å°†ç´¢å¼•é¡µçš„ä¿®æ”¹è®°å½•åˆ° redo logï¼Œç¡®ä¿åœ¨ç³»ç»Ÿå´©æºƒæ—¶å¯ä»¥æ¢å¤åˆ°æ’å…¥æ“ä½œå®Œæˆåçš„çŠ¶æ€ï¼Œé¿å…ç´¢å¼•æ•°æ®å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚<br>äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µï¼šç›®çš„æ˜¯ä¸ºæ•´ä¸ªäº‹åŠ¡çš„æäº¤åšå‡†å¤‡ï¼Œç¡®ä¿äº‹åŠ¡çš„æ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½å·²ç»è¢«æŒä¹…åŒ–è®°å½•ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ‰€æœ‰å‚ä¸äº‹åŠ¡çš„èµ„æºç®¡ç†å™¨éƒ½éœ€è¦å®Œæˆ mtr.commit() æ“ä½œï¼Œå°†ç›¸å…³ä¿®æ”¹å†™å…¥ redo log å¹¶åˆ·ç›˜ï¼Œä»¥å‘äº‹åŠ¡åè°ƒå™¨è¡¨æ˜è‡ªå·±å‡†å¤‡å¥½æäº¤äº‹åŠ¡ï¼Œä¸ºåç»­çš„æäº¤é˜¶æ®µå¥ å®šåŸºç¡€ã€‚</li>
<li>åç»­æ“ä½œ<br>æ’å…¥ç´¢å¼•æ•°æ®æ—¶ï¼šåœ¨ mtr.commit() è°ƒç”¨å®Œæˆåï¼Œäº‹åŠ¡å¯èƒ½ä¼šç»§ç»­è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå¦‚æ’å…¥æ›´å¤šçš„ç´¢å¼•æ•°æ®ã€ä¿®æ”¹æ•°æ®è®°å½•ç­‰ã€‚åç»­çš„æ“ä½œä¼šå¼€å¯æ–°çš„ MTR å¹¶é‡å¤ç±»ä¼¼çš„è¿‡ç¨‹ã€‚<br>äº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µï¼šåœ¨ mtr.commit() è°ƒç”¨å®Œæˆåï¼Œèµ„æºç®¡ç†å™¨ä¼šå‘äº‹åŠ¡åè°ƒå™¨å‘é€ â€œå‡†å¤‡å¥½æäº¤ï¼ˆReady to Commitï¼‰â€ çš„æ¶ˆæ¯ã€‚äº‹åŠ¡åè°ƒå™¨ä¼šæ ¹æ®æ‰€æœ‰èµ„æºç®¡ç†å™¨çš„åé¦ˆæ¥å†³å®šæ˜¯å¦è¿›å…¥æäº¤é˜¶æ®µã€‚å¦‚æœæ‰€æœ‰èµ„æºç®¡ç†å™¨éƒ½å‡†å¤‡å¥½ï¼Œäº‹åŠ¡åè°ƒå™¨ä¼šå‘èµ·æäº¤æŒ‡ä»¤ï¼›å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªèµ„æºç®¡ç†å™¨æ— æ³•å‡†å¤‡å¥½ï¼Œäº‹åŠ¡åè°ƒå™¨ä¼šå‘èµ·å›æ»šæŒ‡ä»¤ã€‚<br>ç»¼ä¸Šæ‰€è¿°ï¼Œè™½ç„¶ mtr.commit() åœ¨æ’å…¥ç´¢å¼•æ•°æ®æ—¶å’Œäº‹åŠ¡äºŒé˜¶æ®µæäº¤çš„ prepare é˜¶æ®µéƒ½ä¼šå†™å…¥ redo logï¼Œä½†å®ƒä»¬åœ¨è°ƒç”¨æ—¶æœºã€å†™å…¥å†…å®¹ã€æ“ä½œç›®çš„å’Œåç»­æ“ä½œç­‰æ–¹é¢å­˜åœ¨æ˜æ˜¾çš„åŒºåˆ«ã€‚</li>
</ol>
<h3 id="5-3-5ã€äº‹åŠ¡æäº¤å°ç»“"><a href="#5-3-5ã€äº‹åŠ¡æäº¤å°ç»“" class="headerlink" title="5.3.5ã€äº‹åŠ¡æäº¤å°ç»“"></a>5.3.5ã€äº‹åŠ¡æäº¤å°ç»“</h3><p>ç”±Binlogæ‹…ä»»åè°ƒè€…çš„XAäº‹åŠ¡å¤„ç†è¿‡ç¨‹:<br><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/Binlog%E6%8B%85%E4%BB%BB%E5%8D%8F%E8%B0%83%E8%80%85%E7%9A%84XA%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B.png" alt="Binlogæ‹…ä»»åè°ƒè€…çš„XAäº‹åŠ¡å¤„ç†è¿‡ç¨‹"></p>
<p><img src="/2020/08/13/2020-08-13-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-insert%E6%B5%81%E7%A8%8B/%E6%9B%B4%E6%96%B0%E6%80%BB%E7%BB%93.png" alt="æ›´æ–°æ€»ç»“"></p>
<p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://www.cnblogs.com/juanmaofeifei/p/16111523.html">MySQLå¯åŠ¨è¿‡ç¨‹è¯¦è§£äºŒï¼šæ ¸å¿ƒæ¨¡å—å¯åŠ¨ init_server_components()</a><br><a href="https://www.cnblogs.com/juanmaofeifei/p/16129144.html">MySQLå¯åŠ¨è¿‡ç¨‹è¯¦è§£ä¸‰ï¼šInnodbå­˜å‚¨å¼•æ“çš„å¯åŠ¨</a><br><a href="https://www.cnblogs.com/juanmaofeifei/p/16146201.html">MySQLè¿æ¥çš„å»ºç«‹ä¸ä½¿ç”¨</a><br><a href="http://ilongda.com/knowledge/mysql/source_code_reading/server/connection.html">MySQL æºç è§£è¯» â€“ è¿æ¥ç®¡ç†</a><br><a href="https://www.aneasystone.com/archives/2018/06/insert-locks-via-mysql-source-code.html">è¯» MySQL æºç å†çœ‹ INSERT åŠ é”æµç¨‹</a><br><a href="https://www.ctyun.cn/developer/article/403942519849029">MySQLäºŒé˜¶æ®µæäº¤åŠç»„æäº¤ç®€æ</a><br><a href="https://www.cnblogs.com/juanmaofeifei/p/16040614.html">MySQLäº‹åŠ¡æäº¤æµç¨‹è¯¦è§£</a><br><a href="https://opensource.actionsky.com/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-mysql-%E7%9A%84-commit-%E6%98%AF%E6%80%8E%E4%B9%88-commit-%E7%9A%84%EF%BC%9F/">æºç åˆ†æ | MySQL çš„ commit æ˜¯æ€ä¹ˆ commit çš„ï¼Ÿ</a><br><a href="https://blog.csdn.net/bohu83/article/details/82903976">MySQL Â· æºç åˆ†æ Â· ä¸€æ¡insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</a><br><a href="https://zhuanlan.zhihu.com/p/451690418">MySQL å¼•æ“ç‰¹æ€§ Â· InnoDB Redo Log è§£æ</a><br><a href="http://mysql.taobao.org/monthly/2017/09/10/">MySQL Â· æºç åˆ†æ Â· ä¸€æ¡insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</a><br><a href="http://mysql.taobao.org/monthly/2021/09/04/">MySQL Â· æºç è¯¦è§£ Â· mini transactionè¯¦è§£</a><br><a href="http://mysql.taobao.org/monthly/2019/03/03/">MySQL Â· InnoDB Â· Redo log</a><br><a href="https://www.pagefault.info/2019/04/18/mtr-minitransaction-design-and-implementation.html">MTR(mini-transaction)è®¾è®¡ä¸å®ç°</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/08/11/2020-08-11-mysql-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="prev" title="ã€Šmysqlã€‹æºç åˆ†æ">
      <i class="fa fa-chevron-left"></i> ã€Šmysqlã€‹æºç åˆ†æ
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/15/2020-08-15-mysql-limit/" rel="next" title="ã€Šmysqlã€‹limit">
      ã€Šmysqlã€‹limit <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81mysql"><span class="nav-text">ä¸€ã€mysql</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-text">äºŒã€æºç æ¶æ„å›¾</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E3%80%81%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84"><span class="nav-text">2.1ã€æºç ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%B8%80%E6%9D%A1Insert%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">ä¸‰ã€ä¸€æ¡Insertè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1%E3%80%81-%E8%A7%A3%E6%9E%90SQL"><span class="nav-text">5.1ã€ è§£æSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2%E3%80%81%E6%89%A7%E8%A1%8CInsert%E8%AF%AD%E5%8F%A5"><span class="nav-text">5.2ã€æ‰§è¡ŒInsertè¯­å¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1%E3%80%81innodb%E6%89%A7%E8%A1%8C%E6%8F%92%E5%85%A5"><span class="nav-text">5.2.1ã€innodbæ‰§è¡Œæ’å…¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-1%E3%80%81%E6%8F%92%E5%85%A5%E7%B4%A2%E5%BC%95%E8%AE%B0%E5%BD%95"><span class="nav-text">5.2.1.1ã€æ’å…¥ç´¢å¼•è®°å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E8%81%9A%E5%90%88%E7%B4%A2%E5%BC%95-Insert-Record%E6%B5%81%E7%A8%8B"><span class="nav-text">1. èšåˆç´¢å¼• Insert Recordæµç¨‹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%8F%90%E4%BA%A4mini-transaction"><span class="nav-text">2. æäº¤mini transaction</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3%E3%80%81%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4"><span class="nav-text">5.3ã€äº‹åŠ¡æäº¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1%E3%80%81%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%80%BB%E6%B5%81%E7%A8%8B"><span class="nav-text">5.3.1ã€äº‹åŠ¡æäº¤æ€»æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2%E3%80%81Prepare-%E9%98%B6%E6%AE%B5"><span class="nav-text">5.3.2ã€Prepare é˜¶æ®µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9ABinlog-Prepare"><span class="nav-text">ç¬¬ä¸€æ­¥ï¼šBinlog Prepare</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9AInnoDB-Prepare"><span class="nav-text">ç¬¬äºŒæ­¥ï¼šInnoDB Prepare</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3%E3%80%81Commit-%E9%98%B6%E6%AE%B5"><span class="nav-text">5.3.3ã€Commit é˜¶æ®µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-3-1%E3%80%81%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="nav-text">5.3.3.1ã€é€»è¾‘åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Stage-0-%E9%98%B6%E6%AE%B5"><span class="nav-text">Stage 0 é˜¶æ®µ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Flush-%E5%AD%90%E9%98%B6%E6%AE%B5"><span class="nav-text">Flush å­é˜¶æ®µ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sync-%E5%AD%90%E9%98%B6%E6%AE%B5"><span class="nav-text">Sync å­é˜¶æ®µ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Commit-%E5%AD%90%E9%98%B6%E6%AE%B5"><span class="nav-text">Commit å­é˜¶æ®µ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-3-2%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">5.3.3.2ã€æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Flush-%E9%98%B6%E6%AE%B5"><span class="nav-text">Flush é˜¶æ®µ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SYNC-%E9%98%B6%E6%AE%B5"><span class="nav-text">SYNC é˜¶æ®µ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#COMMIT-%E9%98%B6%E6%AE%B5"><span class="nav-text">COMMIT é˜¶æ®µ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-3-3%E3%80%81commit%E9%98%B6%E6%AE%B5%E5%B0%8F%E7%BB%93"><span class="nav-text">5.3.3.3ã€commité˜¶æ®µå°ç»“</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-4%E3%80%81mtr-t-commit"><span class="nav-text">5.3.4ã€mtr_t::commit()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-4-1%E3%80%81%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="nav-text">5.3.4.1ã€å¦‚ä½•ä½¿ç”¨ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-4-2%E3%80%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-text">5.3.4.2ã€åŸºæœ¬åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-4-3%E3%80%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">5.3.4.3ã€æ‰§è¡Œæµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-4-4%E3%80%81%E5%B0%8F%E7%BB%93"><span class="nav-text">5.3.4.4ã€å°ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%9B%B8%E5%90%8C%E7%82%B9%EF%BC%9A%E5%86%99%E5%85%A5-redo-log"><span class="nav-text">1. ç›¸åŒç‚¹ï¼šå†™å…¥ redo log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%B8%A4%E6%AC%A1%E8%B0%83%E7%94%A8%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">2. ä¸¤æ¬¡è°ƒç”¨çš„åŒºåˆ«</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-5%E3%80%81%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E5%B0%8F%E7%BB%93"><span class="nav-text">5.3.5ã€äº‹åŠ¡æäº¤å°ç»“</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="chw"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">chw</p>
  <div class="site-description" itemprop="description">do somthing</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">157</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">133</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chw</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
