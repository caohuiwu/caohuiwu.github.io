---
title: 《稳定性》线程池要设置多大
date: 2024-06-15 10:00:00
categories:
  - [java, 并发, 线程池]
  - [稳定性]
  - [阿里]
tags:
- 阿里
---

    这是稳定性系列的第四篇文章，主要介绍的是线程池的设置。

<style>
.my-code {
   color: orange;
}
.orange {
   color: rgb(255, 53, 2)
}
.red {
   color: red
}
code {
   color: #0ABF5B;
}
</style>


# 一、理论分析
## 1.1、N+1 和 2N的说法来源
<!-- more -->
**业界的一些线程池参数配置方案：**
![线程池参数配置方案](2024-06-15-稳定性-线程池要设置多大/线程池参数配置方案.png)
源自2006年出版的《Java并发编程》这本书里，给出的公式如上图（第一种）：
> `N+1`：CPU密集型任务，线程几乎一直在执行计算，很少阻塞。N+1可以确保即使一个线程阻塞，其他N个线程扔能充分利用CPU。
> `2N`：IO密集型任务，线程频繁阻塞（如等待网络、数据库、文件IO），理论上，2N线程可使CPU利用率接近100%（假设每个线程的IO等待时间均匀分布）

现实情况下，假设一个简单查询，等待时间大约是10ms，计算时间是2ms，理论是5N个线程数量。`但是为什么可以设置成这么高，大家不敢设置呢？`
```text
是因为长久以来有个一贯的说法是：上下文切换会带来CPU的空转损耗，但是没人告诉你，CPU上下文切换这种说法呢是源自1961年有其时代的局限性
• 1961年的上下文切换耗时：在数百微秒到毫秒级别（如100~1000us），主要受限于低主频、慢内存和缺乏硬件支持。
• 现在的CPU上下文切换耗时大约是1~3微秒左右。

微秒 (μs)
• 换算关系：1 ms = 1000 μs。

每核每秒切换线程上下文1000次 * 每次3μs = 3000μs
• 3000μs/1000 = 3ms -> 1s中损耗3ms，损耗极少
```
在极端的高并发情况下，有`几十万个线程`正在切换才会造成巨大影响，否则以Tomcat为例，200个线程或者是1000、2000个线程切换，这个损耗几乎可以忽略不计的。
> 200000*3μs /1000/1000=0.6s，此时线程上下文切换会对性能造成巨大影响。



## 1.2、理论设计
一般思路：会使用`第3种`计算方式去得到大致的线程池数量。
> 示例如下：假设1秒需要执行1000个任务，每个任务执行耗时40ms，那么需要多少个线程？
> 
> 公式：任务个数/每秒执行个数=线程数量
> - 1000/(1000/40)=40个线程

**和CPU利用率的关系：**
> 示例如下：任务执行耗时40ms，其中计算10ms，数据库IO为30ms。
> 
> CPU利用率=10/40=25%

**线程数量&队列&流量关系：**
![线程池参数配置方案](2024-06-15-稳定性-线程池要设置多大/队列和流量的关系.png)
> - **线程处理速度 < 流量：** 导致队列堆积，导致影响业务，极端情况下OOM；
> - **线程处理速度 = 流量：** 比较稳定的情况，一般不会出现大问题。
> - **线程处理速度 > 流量：** 有可能是线程数量过多，造成资源浪费。

# 三、实际业务
在实际业务中，为了系统稳定性，每个业务都会有独立的线程池，所以会存在多个线程池。那如果一个新业务来了，我们应该怎么设置线程池数量呢？这篇文章为订单拉单的后序文章。

## 3.1、线程预估
这一步操作还是需要的，基于新业务的特性，根据理论分析，估算出大致的线程数量。预估出来后，我们应该怎么做呢？

## 3.2、分析影响
预估出来后，需要分析影响。

增加线程池，有可能会对现有业务造成影响（不管有木有影响，我们还是得去做考虑），应该从哪些方面进行分析呢？

**方面1：业务响应时间 & 吞吐量**        
为什么需要考虑这个？
> 新增线程池后，新任务会去抢占CPU的运行时间，造成进程上下文的切换，导致原有业务的执行时间减少，最终体现到响应时间和吞吐量上。
> - 解决方法：减少线程数量，增大队列，减少上下文切换。实际操作上，无法具体分析出影响范围有多大。
>   - 最佳实践：采用灰度发布的方式，逐步将新线程池引入现有业务系统；同时对现有业务的监控指标进行观察。
****
**方面2：[CPU负载 & CPU利用率：](https://caohuiwu.github.io/2024/06/05/2024-06-05-Linux-CPU%E8%B4%9F%E8%BD%BD%E5%92%8C%E5%88%A9%E7%94%A8%E7%8E%87/#more)**
> 1. 造成CPU负载的升高：增加线程池，那么会有更多的任务需要处理。例如I/O 密集型任务，这些进程会处于等待 I/O 完成的状态，此时它们并不占用大量的 CPU 资源，但会被计入系统负载中。
>    1. 解决方法：根据不同的造成因素做不同的处理。
>    2. 例如应用程序问题，则优化程序；
>    3. 如果是机器问题，则增加CPU核心数量或升级硬件；
> 2. 进程频繁上下文切换：
>    1. 更多的任务，那么会竞争CPU使用资源，就会造成进程频繁上下文切换，会消耗一定的系统资源。

因此我们需要去查看CPU负载 & CPU利用率，保证增加线程池后，两项指标不会升高到预期之外，并且不对其他现有业务造成过大的影响。
****
**方面3：内存：**
> 每开启一个线程都需要内存空间，并且任务堆积情况下，会造成内存消耗，极端情况下造成oom。

## 3.3、我们应该怎么做？
> 最佳实践：采用灰度发布的方式，逐步将新线程池引入现有业务系统；同时对现有业务的监控指标进行观察。


参考文章：   
[Java线程池实现原理及其在美团业务中的实践](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)      
[线程池的数量和线程池中线程数量如何设置-实践篇](https://juejin.cn/post/7067183465224994852#heading-5)


