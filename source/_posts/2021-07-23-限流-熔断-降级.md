---
title: 限流-熔断-降级
date: 2021-07-23
---


<style>
.my-code {
   color: orange;
}
.orange {
   color: rgb(255, 53, 2)
}
.red {
   color: red
}
code {
   color: #0ABF5B;
}
</style>

# 一、限流-熔断-降级
限流、熔断、降级是微服务架构中常用的保护机制。
<!--more-->



# 二、限流（Rate Limiting）

## 2.1、定义
通过限制系统处理请求的速率，防止因突发流量或恶意攻击导致系统过载。

## 2.2、核心目标
防御过载：确保系统在安全容量内运行。
保护资源：防止数据库、第三方服务等被过多请求压垮。

## 2.3、实现策略

| 算法     | 原理                                 | 适用场景               |
|--------|------------------------------------|--------------------|
| 令牌桶算法  | 以固定速率向桶中添加令牌，请求需获取令牌才能通过。允许突发流量    | 需要支持突发流量的场景（如电商秒杀） |
| 漏桶算法   | 以固定速率处理请求，多余的请求被丢弃。平滑流量，但无法应对突发流量  | 需要一个限流的创建（如数据库写入）  |
| 滑动窗口算法 | 动态统计时间窗口内的请求数，避免固定窗口的“流量突刺”问题      | 高精度限流需求（如API网关）    |
| 固定窗口计数 | 统计固定时间窗口内的请求数，超时阈值则拒绝。实现简单，但存在流量突刺 | 简单场景（如接口调用限制）      |



# 三、熔断（circuit Breaker）

## 3.1、定义
当服务调用出现故障（如超时、异常）时，主动中断请求，防止故障扩散，类似电路中的保险丝。

## 3.2、核心目标
防止故障扩散：避免因单个服务故障导致级联崩溃（雪崩效应）。
快速失效：直接返回错误，避免长时间等待。
自动恢复：通过半开状态试探性恢复服务。

## 3.3、工作状态

| 状态 | 描述                                |
|----|-----------------------------------|
| 关闭 | 正常调用服务，统计错误率。当错误率超过阈值时切换为“打开”状态   |
| 打开 | 拒绝所有请求，直接返回错误（降级逻辑）。持续时间由预设时间窗口决定 |
| 半开 | 允许少量请求通过，若成功则恢复“关闭”状态，否则继续“打开”    |

## 3.4、实现技术
- sentinel：支持RT（响应时间）、异常率等熔断策略，提供控制台配置。
- Hystrix：经典熔断库
- Resilience4j：轻量级替代Hystrix，支持响应式编程。

# 四、降级（Degradation）

## 4.1、定义
在服务不可用或高负载时，主动返回默认值或简化逻辑，确保核心功能可用。

## 4.2、核心目标
- 保障核心功能：牺牲非核心功能，保障用户体验。
- 资源优先级：优先处理关键业务，释放系统资源。

## 4.3、实现方式

| 策略     | 示例                                                             |
|--------|----------------------------------------------------------------|
| 返回默认值  | 从缓存返回旧数据，或提供空值（如商品详情页显示静态图片）                                   |
| 简化逻辑   | 关闭推荐功能，仅返回基础数据（如商品详情页的推荐信息）                                    |
| 提示用户   | 返回“服务异常，请稍后再试”提示，避免空白页面                                        |
| 限流结合降级 | 超出限流阈值时返回降级响应（如“活动火爆，请稍后再试”）                                   |
| 写降级    | 比如秒杀抢购，我们可以只进行Cache的更新，然后异步同步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache |
| 读降级    | 比如多级缓存模式，如果后端服务有问题，可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景               |


# 五、总结

## 5.1、三者的核心区别与联系

| 维度	      | 限流	            | 熔断                         | 	降级                |
|----------|----------------|----------------------------|--------------------|
| 触发条件     | 请求速率超过阈值	      | 服务调用失败率或响应时间超过阈值           | 	服务不可用或系统过载        |
| 核心目标     | 控制流量，防止过载      | 	防止故障扩散，快速失败	              | 保证核心功能，牺牲非核心服务     |
| 作用范围     | 全局或接口级别的流量控制   | 	服务调用链路级别的保护               | 	业务功能级别的功能裁剪       |
| 典型场景     | 高峰流量、防攻击	      | 第三方服务超时、数据库响应慢             | 	非核心功能故障、系统资源不足    |
| 技术实现     | 令牌桶、漏桶算法	      | 熔断器三态机制（Sentinel、Hystrix）  | 	业务逻辑中的Fallback实现  |
| 是否自动恢复	  | 需手动调整阈值或动态配置	  | 熔断器自动切换状态（如半开恢复）           | 	通常需要人工干预或配置开关     |

## 5.2、小结
- **限流**：控制流量入口，防止系统过载。
- **熔断**：切断故障链路，防止级联崩溃。
- **降级**：牺牲非核心功能，保障核心可用。


三者需结合使用，形成完整的流量治理方案。例如：
- **限流+熔断**：在高并发时限流，熔断不可用服务。
- **熔断+降级**：熔断后返回降级逻辑，提升用户体验。
- **限流+降级**：超出限流阈值时直接返回降级响应，避免资源浪费。