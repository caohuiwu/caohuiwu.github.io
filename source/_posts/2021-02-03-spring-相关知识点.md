---
title: 《spring》相关知识点
date: 2021-02-03
categories:
  - [spring, 事务]
---

    这是spring系列的第14篇文章，主要介绍的是Spring的相关知识点。

<style>
.my-code {
   color: orange;
}
.orange {
   color: rgb(255, 53, 2)
}
.red {
   color: red
}
code {
   color: #0ABF5B;
}
</style>

# 一、Spring
`spring框架`是Java生态中最主流的轻量级开源应用框架，其核心目标是简化企业级应用开发，通过`IOC（控制反转）`和`AOP（面向切面编程）`两大核心机制实现解耦、模块化和可维护性。

<!-- more -->

# 二、Bean的创建方式
- `@PreConstract`
- `Initialization`
- `init-method`



# 三、InitializingBean接口

## 3.1、接口定义
`InitializingBean`接口位于`org.springframework.beans.factory`包中，仅定义了一个方法：
```java
void afterPropertiesSet() throws Exception;
```
当Bean的所有属性被Spring容器注入后，`afterPropertiesSet()`方法会被自动调用。

## 3.2、执行流程
在对象的创建流程中，当Bean的属性完成依赖注入后，执行初始化逻辑，例如资源加载、连接初始化。执行堆栈如下，执行`invokeInitMethods`方法
```java
AbstractBeanFactory.doGetBean
-> DefaultSingletonBeanRegistry.getSingleton
    -> AbstractBeanFactory.getObject
        -> AbstractAutowireCapableBeanFactory.createBean
            -> AbstractAutowireCapableBeanFactory.doCreateBean
                -> AbstractAutowireCapableBeanFactory.initializeBean：初始化Bean
                    -> AbstractAutowireCapableBeanFactory.invokeInitMethods
```
`invokeInitMethods`方法执行逻辑如下：
```java
protected void invokeInitMethods(String beanName, Object bean, @Nullable RootBeanDefinition mbd)
        throws Throwable {

    boolean isInitializingBean = (bean instanceof InitializingBean);
    if (isInitializingBean && (mbd == null || !mbd.isExternallyManagedInitMethod("afterPropertiesSet"))) {
        if (logger.isTraceEnabled()) {
            logger.trace("Invoking afterPropertiesSet() on bean with name '" + beanName + "'");
        }
        if (System.getSecurityManager() != null) {
            // ... [代码部分省略以简化]
        }
        else {
            ((InitializingBean) bean).afterPropertiesSet();
        }
    }
    if (mbd != null) {
        String initMethodName = mbd.getInitMethodName();
        if (initMethodName != null && !(isInitializingBean && "afterPropertiesSet".equals(initMethodName)) &&
                !mbd.isExternallyManagedInitMethod(initMethodName)) {
            invokeCustomInitMethod(beanName, bean, mbd);
        }
    }
}
```


## XML配置init-method
```java
<bean id="myBean" class="com.example.MyBean" init-method="customInit">
    <!-- 属性配置 -->
</bean>
```


在Spring容器中，`InitializingBean`的`afterPropertiesSet()`方法的执行优先级高于通过`init-method`指定的初始化方法。具体顺序如下：
- 构造函数：Bean的构造方法执行。
- 属性注入：Spring容器注入依赖属性。
- `@PostConstruct`：如果Bean有@PostConstruct注解的方法，该方法会在此时执行。
- `InitializingBean.afterPropertiesSet()`：调用afterPropertiesSet()方法。
- `init-method`：调用通过init-method属性指定的初始化方法（如XML配置或@Bean(initMethod="...")）。


## 使用案例

策略模式实现
```java
@Service
public class StrategyService implements ApplicationContextAware, InitializingBean {
    private ApplicationContext context;
    private List<Strategy> strategies = new ArrayList<>();

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        this.context = applicationContext;
    }

    @Override
    public void afterPropertiesSet() {
        strategies.addAll(context.getBeansOfType(Strategy.class).values());
    }
}
```

成功的使用案例：mybatis的sqlSessionFactoryBean

# 四、FactoryBean
`FactoryBean`是Spring框架提供的一个接口，用于自定义Bean的实例化逻辑。通过实现`FactoryBean`接口，可以返回一个复杂对象（通过`getObject()`方法），而`FactoryBean`本身也是一个Spring管理的Bean。
```java
package org.springframework.beans.factory;
public interface FactoryBean<T> {
    // 返回实际创建的Bean对象（目标对象）
    T getObject() throws Exception;
    // 返回目标对象的类型（可以是接口或具体类）
    Class<?> getObjectType();
    // 指定目标对象的作用域（是否为单例）
    boolean isSingleton(); // 默认返回 true（单例）
}
```

## 4.1、典型场景：
`Mybatis`的`SqlSessionFactoryBean`
- `Mybatis`通过`SqlSessionFactoryBean`实现Spring管理`SqlSessionFactory`，内部封装了数据源、配置文件加载等复杂逻辑。
```java
public class SqlSessionFactoryBean
    implements FactoryBean<SqlSessionFactory>, InitializingBean, ApplicationListener<ApplicationEvent> {
    @Override
    public SqlSessionFactory getObject() throws Exception {
        if (this.sqlSessionFactory == null) {
            afterPropertiesSet();
        }

        return this.sqlSessionFactory;
    }
}
```
更多内容，查看Mybatis的启动过程、执行过程文章。