---
title: 熔断降级
date: 2019-08-21 18:26:30
tags:
---

# 一、背景
* 线索系统调用更新权限接口，调用量过大，导致权限系统资源消耗过大
    * 线索系统业务受到影响
    * 权限系统无法对外提供服务
    * 其他系统业务然后都收到影响
    
此时需要对服务做服务降级处理。    

# 一、服务雪崩

例如三个系统，A，B，C，
* 调用关系：A -> B -> C，调用链
    * 如果此时C服务异常，无法提供服务
    * B服务此时因为C服务不可用，可能B服务会去重试，资源容易消耗殆尽，变得不可用
    * 最终结果是，三个服务都不可用
    
如何解决服务雪崩呢？做降级处理，降级的方案
* 限流降级
* 熔断降级

# 二、限流降级
例如C服务，因为瞬时的访问量突然变大，而导致自己不可用，可以考虑限流处理，防止自己宕机，这是一种降级处理。


# 三、熔断降级
调用链上，C服务不可用，B服务也将不可用，那么服务B然后解决因为下游系统不可用导致的服务雪崩问题呢？
* 使用熔断降级
    * B服务调用C服务，例如每20个请求内有50%失败，则打开熔断降级开关，进行降级处理，B服务降级处理可以是返回错误码
* 熔断逻辑如下几种：    
```
Hystrix
//滑动窗口的大小，默认为20
circuitBreaker.requestVolumeThreshold 
//过多长时间，熔断器再次检测是否开启，默认为5000，即5s钟
circuitBreaker.sleepWindowInMilliseconds 
//错误率，默认50%
circuitBreaker.errorThresholdPercentage
```

# 四、分布式限流
采用滑动窗口实现限流。

限流的实现方式：
* 计数器：
    * 给定一定数量，例如使用Redis的计数器。
* 漏斗模式：
    * 固定流出，不支持瞬时流量突增。
    * 实现：例如线程池，固定的队列大小，固定线程数去消费
* 令牌桶：
    * 固定流入，支持瞬时流量突增。
* 滑动窗口：
    * 



## 分布式限流
一种是基于Redis做分布式限流，另一种类似于Sentinel分布式限流。

### Sentinel
Sentinel分布式限流是启动一个token server服务器，其他sentinel client端就是token client端，当做限流操作时，
从token server获取token，获取成功表示未触发限流；否则表示触发了限流；通信出现异常，可配置降级走本地Sentinel限流机制。
分布式限流文档：Sentinel集群流控

sentinel的分布式限流是token client调用以下方法到服务端获取token，相当于是每次都会获取acquireCount个token：


