---
title: 《nginx》相关知识点
date: 2021-05-27
categories:
  - [nginx]
---

    这是nginx系列的第4篇文章，主要介绍的是nginx的限流等等相关知识点。

<style>
.my-code {
   color: orange;
}
.orange {
   color: rgb(255, 53, 2)
}
.red {
   color: red
}
code {
   color: #0ABF5B;
}
</style>

# 一、Nginx是什么？
`Nginx`是一个高性能的http和反向代理服务器，其特点是占用内存小，并发能力强

<!--more-->

# 二、限流

## 2.1、两种限流方式
- 限制请求速率
- 限制并发连接数

### 2.1.1、`ngx_http_limit_req_module`（请求速率限制）
- **功能**：基于 **漏桶算法（Leaky Bucket）** 限制客户端请求速率。
- **适用场景**：限制每秒请求数（QPS），如 API 接口限流。
- **核心指令**：
```nginx
# 定义共享内存区和速率规则（10MB 内存，平均速率 10 请求/秒）
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

server {
location /api/ {
  # 应用限流规则，允许突发 20 请求（缓冲队列）
  limit_req zone=api_limit burst=20 nodelay;
  # 超限返回 503 状态码
  limit_req_status 503;
}
}
```
- `burst`：允许的突发请求数，超出后排队或丢弃（结合 `nodelay` 立即处理突发，不延迟）。
- `nodelay`：突发请求不延迟处理，直接消耗令牌。

### 2.1.2、`ngx_http_limit_conn_module`（并发连接数限制）
- **功能**：限制同一客户端的并发连接数。
- **适用场景**：防止单个 IP 占用过多连接，如下载服务限速。
- **核心指令**：
```nginx
  # 定义共享内存区和连接数限制（10MB 内存，每个 IP 允许 100 并发）
  limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

  server {
      location /download/ {
          # 应用连接数限制
          limit_conn conn_limit 100;
          # 超限返回 503 状态码
          limit_conn_status 503;
      }
  }
  ```



## 2.2、限流策略与配置示例

### 1. 基础速率限制（QPS 控制）
```nginx
http {
    # 定义限流规则：每个 IP 每秒 50 请求，允许突发 100
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=50r/s;

    server {
        location / {
            limit_req zone=req_limit burst=100;
            proxy_pass http://backend;
        }
    }
}
```

### 2. 并发连接数限制
```nginx
http {
    # 定义并发限制：每个 IP 最多 50 并发连接
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        location / {
            limit_conn conn_limit 50;
            proxy_pass http://backend;
        }
    }
}
```

### 3. 组合限流（请求速率 + 并发连接）
```nginx
http {
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=100r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        location /api/ {
            limit_req zone=req_limit burst=50;
            limit_conn conn_limit 20;
            proxy_pass http://backend;
        }
    }
}
```

### 4. 基于地理位置的差异化限流
```nginx
geo $limit {
    default          "";
    192.168.0.0/24   $binary_remote_addr; # 内网不限流
}

map $limit $limit_key {
    ""      "";       # 不限流的请求 key 为空
    default $binary_remote_addr;
}

limit_req_zone $limit_key zone=geo_limit:10m rate=30r/s;

server {
    location / {
        limit_req zone=geo_limit burst=10;
        proxy_pass http://backend;
    }
}
```